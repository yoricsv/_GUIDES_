---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Закодированные инъекции

## Предпосылки

Кодирование символов — процесс приведения символов, чисел и других символов к стандартному формату. Как правило, это делается при создании сообщения для передачи от отправителя получателю. Проще говоря, это преобразование символов (принадлежащих различным языкам, таким как английский, китайский, русский или любой другой) в байты. Примером широко используемой схемы кодирования символов является Американский стандартный код для обмена информацией (англ.: American Standard Code for Information Interchange, ASCII), в котором раньше использовались 7-битные коды. Более свежими примерами схем кодирования могут быть отраслевые стандарты Unicode `UTF-8` и `UTF-16`.

В области безопасности приложений и из-за множества имеющихся схем кодирования кодировка символов широко используется не по назначению. Например, для кодирования вредоносных строк инъекций, таким образом, чтобы обфусцировать их. Это может привести к обходу фильтров проверки ввода или использованию определенных способов, которыми браузеры отображают закодированный текст.

## Кодирование входных данных — уклонение от фильтра

Web-приложения обычно применяют различные типы механизмов фильтрации входных данных, чтобы ограничить ввод от пользователя. Если эти входные фильтры реализованы недостаточно хорошо, можно пропустить один или два символа через эти фильтры. Например `/` может быть представлен как `2F` (hex) в ASCII, в то время как тот же символ (`/`) кодируется как `C0` `AF` в Unicode (2-байтовая последовательность). Поэтому фильтру входных данных важно знать о применяемой схеме кодирования. Если обнаружено, что фильтр обнаруживает только инъекции в кодировке `UTF-8`, для обхода этого фильтра можно использовать другую схему кодирования.

## Кодирование вывода — консенсус между сервером и браузером

Web-браузеры должны знать о схеме кодирования, используемой для согласованного отображения web-страницы. В идеале эта информация должна быть предоставлена браузеру в поле HTTP-заголовка (`Content-Type`), как показано ниже:

```http
Content-Type: text/html; charset=UTF-8
```

или через HTML META-тег (`META HTTP-EQUIV`), как показано ниже:

``` html
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-5">
```

Именно благодаря этим объявлениям кодировки символов браузер понимает, какой набор символов применять при преобразовании байтов в символы. Обратите внимание, что `Content-Type`, указанный в HTTP-заголовке, имеет приоритет над объявлением МЕТА-тега.

CERT описывает это следующим образом:

На многих web-страницах кодировка символов (параметр `charset` в HTTP) не определена. В более ранних версиях HTML и HTTP предполагалось, что по умолчанию используется `ISO-8859-1`, если иная не указана явно. На самом деле у многих браузеров было другое значение по умолчанию, поэтому полагаться на него было нельзя. HTML версии 4 это узаконил — если кодировка символов не указана, можно использовать любую.

Если web-сервер не указывает кодировку символов, то он не говорит, какие символы являются специальными. Web-страницы с неопределённой кодировкой символов работоспособны в большинстве случаев, потому что в большинстве наборов символов значениям байтов ниже 128 назначаются одни и те же символы. Но какие из значений выше 128 являются специальными? Некоторые 16-битные схемы кодирования символов имеют дополнительные многобайтовые представления для специальных символов, таких как `<`. Некоторые браузеры распознают эту альтернативную кодировку и действуют в соответствии с ней. Это «правильное» поведение, но оно значительно затрудняет предотвращение атак с использованием вредоносных скриптов. Сервер просто не знает, какие последовательности байтов представляют специальные символы.

Поэтому в случае неполучения информации о кодировке символов с сервера браузер либо пытается угадать её, либо возвращается к схеме по умолчанию. В некоторых случаях пользователь браузера явно устанавливает свою кодировку по умолчанию. Любое такое несоответствие в схеме кодирования, используемой web-страницей (сервером) и браузером, может привести к тому, что браузер интерпретирует страницу непредусмотренным или неожиданным образом.

### Закодированные инъекции

Все приведённые ниже сценарии составляют небольшую часть различных способов обфускации для обхода входных фильтров. Кроме того, успех закодированных инъекций зависит от используемого браузера. Например, инъекции в кодировке `US-ASCII` ранее были успешными только в браузере IE, но не в Firefox. Следовательно, можно отметить, что успех закодированных инъекций в значительной степени зависит от браузера.

### Базовая кодировка

Рассмотрим простой фильтр для контроля входных данных, который защищает от инъекции символа одинарной кавычки. В этом случае следующая инъекция легко обошла бы этот фильтр:

``` html
<script>alert(String.fromCharCode(88,83,83))</script>
```

Функция `String.fromCharCode` в JavaScript принимает значения, заданные в Unicode и возвращает соответствующую строку. Это одна из самых простых форм закодированных инъекций. Другой вектор, который можно использовать для обхода этого фильтра:

``` html
<IMG src="" onerror=javascript:alert(&quot;XSS&quot;)>
```

Или с помощью соответствующих [кодов символов в HTML](https://www.rapidtables.com/code/text/unicode-characters.html):

``` html
<IMG src="" onerror="javascript:alert(&#34;XSS&#34;)">
```

В приведённом выше примере для построения строки ввода используются [HTML-сущности](https://developer.mozilla.org/ru/docs/Glossary/Entity). Кодировка HTML-сущностей используется для отображения символов, которые имеют особое значение в HTML. Например, `>` интерпретируется как закрывающая скобка для HTML-тега. Для того, чтобы действительно отобразить этот символ на web-странице, символы HTML-сущностей (или мнемоники) должны быть вставлены в исходный код страницы. Инъекции, упомянутые выше, являются одним из способов кодирования. Существует множество других способов кодирования (обфускации) строки для обхода вышеуказанного фильтра.

### Шестнадцатеричная кодировка

Hex, сокращение от Hexadecimal, представляет собой систему счисления с основанием 16, то есть она имеет 16 различных значений от `0` до `9` и от `A` до `F` для представления различных символов. Шестнадцатеричное кодирование — это ещё одна форма обфускации, которая иногда используется для обхода фильтров входного контроля. Например, шестнадцатеричная версия строки `<IMG SRC=javascript:alert('XSS')>`:

``` html
<IMG SRC=%6A%61%76%61%73%63%72%69%70%74%3A%61%6C%65%72%74%28%27%58%53%53%27%29>
```

Вариант приведенной выше строки приведен ниже. Может использоваться в случае фильтрации `%`:

``` html
<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>
```

Есть и другие схемы кодирования, такие как Base64 и восьмеричная, которые можно использовать для обфускации. И хотя не каждая схема всегда работает, немного проб и ошибок в сочетании с разумными манипуляциями определённо выявят лазейку в недостаточно продуманном фильтре входного контроля.

### Кодировка UTF-7

В кодировке UTF-7

``` html
<SCRIPT>
    alert(‘XSS’);
</SCRIPT>
```

выглядит так:

`+ADw-SCRIPT+AD4-alert('XSS');+ADw-/SCRIPT+AD4-`

Чтобы приведенный выше сценарий работал, браузер должен интерпретировать web-страницу как закодированную в `UTF-7`.

### Многобайтовые кодировки

Кодировки переменной ширины — это ещё один тип схемы кодирования символов, в которой используются коды различного размера. [Многобайтовые кодировки](https://learn.microsoft.com/ru-ru/cpp/text/support-for-multibyte-character-sets-mbcss) — это тип кодирования с переменной шириной, в котором для представления символа используется различное количество байтов. Многобайтовые кодировки в основном используются для кодирования с большими наборами символов, например, для китайского, японского и корейского языков.

В прошлом многобайтовые кодировки использовались для обхода стандартных функций контроля ввода, выполнения межсайтовых скриптов и атак путём SQL-инъекций.

## Ссылки

- [Encoding (Semiotics)](https://en.wikipedia.org/wiki/Encoding_(semiotics))
- [HTML Entities](https://www.w3schools.com/HTML/html_entities.asp)
- [How to prevent input validation attacks](https://searchsecurity.techtarget.com/answer/How-to-prevent-input-validation-attacks)
- [Unicode and Character Sets](https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/)
