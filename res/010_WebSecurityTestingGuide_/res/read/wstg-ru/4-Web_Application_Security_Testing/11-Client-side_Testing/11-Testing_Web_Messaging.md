---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование обмена web-сообщениями

|ID          |
|------------|
|WSTG-CLNT-11|

## Обзор

Обмен web-сообщениями (также известный как [обмен сообщениями между документами](https://html.spec.whatwg.org/multipage/web-messaging.html#web-messaging)) позволяет приложениям, находящимся в разных доменах, безопасно обмениваться данными. До появления web-сообщений обмен между источниками из разных доменов (через фреймы, вкладки и окна) ограничивался применяемой браузером политикой одного источника (англ.: same origin policy). Разработчики использовали несколько трюков для решения этих задач, но большинство из них были в основном небезопасными.

Это ограничение в браузере введено для того, чтобы вредоносный сайт не мог читать чувствительные данные с других фреймов, вкладок и т.д.; Однако есть законные случаи, когда двум доверенным сайтам необходимо обмениваться данными друг с другом. Чтобы удовлетворить эту потребность, в проект спецификации [HTML5](https://html.spec.whatwg.org/multipage/) был внесён обмен сообщениями между документами, который теперь реализован во всех основных браузерах. Он обеспечивает безопасный обмен между источниками из разных доменов через iframe, вкладки и окна.

API обмена сообщениями представляет метод [`postMessage()` method](https://developer.mozilla.org/ru/docs/Web/API/Window/postMessage), с помощью которого можно отправлять сообщения в виде обычного текста между разными доменами. Метод состоит из двух параметров: сообщения и домена.

При использовании `*` в качестве домена есть некоторые вопросы безопасности, которые мы обсудим ниже. Чтобы получать сообщения, принимающий сайт должен добавить новый обработчик событий со следующими атрибутами:

- Data — содержание входящего сообщения;
- Origin — адрес документа отправителя;
- Source — окно отправителя.

Ниже пример использования API обмена сообщениями. Чтобы отправить сообщение:

```js
iframe1.contentWindow.postMessage("Hello world","http://www.example.com");
```

Чтобы принять сообщение:

```js
window.addEventListener("message", handler, true);
function handler(event) {
    if(event.origin === 'chat.example.com') {
        /* обработать сообщение (event.data) */
    } else {
        /* игнорировать сообщения из недоверенных доменов */
    }
}
```

### Безопасность отправителя сообщения

Источник сообщений (Origin) состоит из схемы, имени хоста и порта. Он однозначно идентифицирует домен, отправляющий или получающий сообщение, и не включает путь или часть фрагмента URL. Например, `https://example.com` будет считаться отличным от `http://example.com`, потому что схема первого — `https`, а второго — `http`. То же относится к web-серверам, работающим в одном домене, но на разных портах.

## Задачи тестирования

- Оценить безопасность отправителя сообщения.
- Убедиться, что он применяет безопасные методы и контролирует передаваемые данные.

## Как тестировать

### Оценить безопасность отправителя

Тестировщики должны проверить, фильтрует ли код приложения, обрабатывает ли сообщения из доверенных доменов. В пределах домена-отправителя также убедитесь, что явно указан домен-получатель и что `*` не используется в качестве второго аргумента в `postMessage()`. Такая практика может вызвать проблемы безопасности и привести к тому, что в случае перенаправления или изменения отправителя другими способами сайт будет передавать данные на неизвестные хосты, что приведёт к утечке чувствительной информации на вредоносные серверы.

Если на web-сайте не предусмотрены меры защиты для ограничения доменов или отправителей, которым разрешено отправлять сообщения на сайт, это может стать угрозой безопасности. Тестировщики должны изучить код для прослушивателей событий сообщений и функцию обратного вызова из метода `addEventListener` для дальнейшего анализа. Домены всегда должны проверяться до обработки данных от них.

### Оценить контроль входных данных

Хотя теоретически web-сайт принимает сообщения только от доверенных доменов, данные всё равно должны рассматриваться как недоверенные, т.к. они получены из внешних источников, и обрабатываться с применением соответствующих мер защиты. Тестировщики должны анализировать код и искать небезопасные методы, в частности, если данные оцениваются с помощью `eval()` или вставляются в DOM с помощью свойства `innerHTML`, что может создать [XSS-уязвимости на основе DOM](01-Testing_for_DOM-based_Cross_Site_Scripting.md).

### Статический анализ кода

Необходимо проанализировать код JavaScript, чтобы определить, как реализован обмен web-сообщениями. В частности, тестировщиков должно интересовать, как web-сайт ограничивает сообщения от недоверенных доменов и как обрабатываются данные даже для доверенных доменов.

В этом примере необходим доступ для всех поддоменов (web, чат, форумы и т.д.) в пределах домена owasp.org. Код пытается принимать любой домен, начинающийся с `.owasp.org`:

```js
window.addEventListener("message", callback, true);

function callback(e) {
    if(e.origin.indexOf(".owasp.org")!=-1) {
        /* обработка сообщения (e.data) */
    }
}
```

Намерение состоит в том, чтобы разрешить такие поддомены, как:

- `www.owasp.org`
- `chat.owasp.org`
- `forums.owasp.org`

К сожалению, это приводит к появлению уязвимостей. Злоумышленник может легко обойти фильтр, поскольку, например, домен `www.owasp.org.attacker.com` тоже будет соответствовать правилу фильтра.

Вот пример кода, в котором отсутствует проверка отправителя. Это очень небезопасно, т.к. он будет принимать входные данные от любого домена:

```js
window.addEventListener("message", callback, true);

function callback(e) {
        /* обработка сообщения (e.data) */
}
```

Вот пример с уязвимостями контроля входных данных, которые могут привести к XSS-атаке:

```js
window.addEventListener("message", callback, true);

function callback(e) {
        if(e.origin === "trusted.domain.com") {
            element.innerHTML= e.data;
        }
}
```

Более безопасным подходом было бы  вместо `innerHTML` использовать свойство `innerText`.

Дополнительные ресурсы OWASP, касающиеся обмена web-сообщениями, см. в [Памятке OWASP по безопасности HTML5](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html)
