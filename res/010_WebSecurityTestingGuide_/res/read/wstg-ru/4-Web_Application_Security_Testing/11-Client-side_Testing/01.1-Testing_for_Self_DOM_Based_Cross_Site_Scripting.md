---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование «само-XSS» на основе DOM

## Обзор

Самостоятельный межсайтовый скриптинг на основе DOM (англ.: self DOM XSS) — это специфическая атака, требующая предварительных знаний об XSS на основе DOM и успешной социальной инженерии. Термин «самостоятельный» здесь указывает на то, что пользователю необходимо ввести полезную нагрузку в поле ввода и, таким образом, самому эксплуатировать уязвимость. Уязвимость специфична ещё и тем, что работу скриптов может блокировать политика защиты контента (англ.: Content Security Policy, CSP) web-сайта.

В этом сценарии термин «приёмник» (англ.: sink) будет использоваться следующим образом: в информатике приёмник, приёмник событий или приёмник данных — это класс или функция, предназначенные для получения входных данных или событий от другого объекта или функции. Таким образом, чтобы найти возможные уязвимости, нам сначала нужно определить приёмники приложения, которое мы хотим протестировать.

## Как тестировать

Процесс тестирования Self DOM XSS выглядит следующим образом:

1. Ищите уязвимые приёмники, которые позволяют пользователю вводить данные.
2. Как только определён возможный приёмник, можно вставить полезную нагрузку.
3. Проверьте журнал ошибок в Инструментах разработчика браузера, чтобы увидеть результат и сделать выводы.
4. Проверьте, сможет ли злоумышленник убедить пользователя вставить полезную нагрузку, не требуя серьёзных технических знаний.

### Пример

Этот конкретный пример взят из [отчёта об ошибке на сайте HackerOne](https://hackerone.com/reports/406587).

В примере на сайте `https://example.com` выполняется следующая функция на JavaScript.

```js
//Marketo Form Code
function strip(html) {
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
}

$('form').submit(function() {
    $('textarea').val(function() {
        return strip($(this).val());
    });
});
```

Злоупотребление этой функцией можно описать следующим образом:

1. Обработчик события `submit` передаёт текущее значение элементов `textarea` функции `strip`.
2. Эта функция создаёт новый элемент `div` и устанавливает полученное значение для свойства `innerHTML`.
3. На последнем шаге она возвращает свойство `textContent` результирующего `div`.

 Подобный код обычно используется для удаления HTML-тегов из строки, поскольку свойство `textContent` содержит строку, которая отображалась браузером при парсинге HTML. Конкретно этот метод по своей сути небезопасен, поскольку он использует `innerHTML`. Когда пользовательский ввод предоставляется свойству `innerHTML`, он парсится браузером и, следовательно, может привести к выполнению вредоносного JavaScript.

Для тестирования уязвимости можно использовать следующую полезную нагрузку.`<img src=x onerror=alert(1) />`

Консоль разработчика отобразит две ошибки: одна указывает на то, что был запрошен `https://www.example.com/x` и выдал ошибку 404 (из-за атрибута src тега img). Другая сообщит о нарушении CSP web-сайта.

Эта вторая ошибка произошла из-за того, что браузер пытается выполнить код JavaScript в атрибуте `onerror`, но CSP сайта предотвратила его выполнение. Те же действия в браузере с отключенной CSP позволили выполнить JavaScript в атрибуте `onerror`.

Злоумышленник может эксплуатировать эту уязвимость, убедив пользователя вставить вредоносную полезную нагрузку в поле «Сообщение» в форме для связи с администрацией сайта, а затем нажать кнопку «Отправить сообщение». Эту атаку можно усилить, убедив пользователя использовать версию браузера, не поддерживающую CSP.

## Меры защиты

Чтобы должным образом защититься от XSS на основе DOM, обратитесь к [Памятке OWASP](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html).

### Ссылки

- [OWASP - межсайтовый скриптинг на основе DOM](https://owasp.org/www-community/attacks/DOM_Based_XSS)
- [Памятка OWASP по CSP](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
