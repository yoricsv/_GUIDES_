---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование платёжных функций

|ID          |
|------------|
|WSTG-BUSL-10|

## Обзор

Многие приложения реализуют платежные функции, включая сайты электронной коммерции, подписки, благотворительные организации, сайты пожертвований и обмена валюты. Безопасность этой функциональности имеет решающее значение, поскольку уязвимости могут позволить злоумышленникам совершать кражи из организации, мошеннические покупки или даже данные платёжных карт у других пользователей. Эти проблемы могут привести не только к репутационному ущербу для организации, но и к значительным финансовым потерям, как от прямых убытков, так и от штрафов со стороны отраслевых регуляторов.

## Задачи тестирования

- Определить, надёжна ли бизнес-логика для функций электронной коммерции.
- Понять, как работают функции оплаты.
- Определить, защищены ли платёжные функции.

## Как тестировать

### Способы интеграции с платёжным шлюзом

Существует несколько различных способов интеграции платёжных функций в приложения, и подход к тестированию будет различаться в зависимости от того, какой из них используется. Наиболее распространённые методы:

- Перенаправление пользователя на сторонний платёжный шлюз.
- Загрузка стороннего платёжного шлюза в IFRAME приложения.
- HTML-форма, которая отправляет междоменный POST-запрос стороннему платёжному шлюзу.
- Приём данных карты напрямую, а затем POST-запрос из серверной части приложения в API платёжного шлюза.

### PCI DSS

Стандарт безопасности данных индустрии платёжных карт (англ.: Payment Card Industry Data Security Standard, PCI DSS) — это стандарт, которому организации обязаны следовать при обработке дебетовых и карточных платежей (хотя важно отметить, что это не закон). Полное обсуждение этого стандарта выходит за рамки данного Руководства (и большинства тестов на проникновение), но тестировщикам полезно знать несколько ключевых моментов.

Наиболее распространённое заблуждение относительно PCI DSS заключается в том, что он применим только к системам, в которых хранятся данные о держателях карт (т.е. данные дебетовых или кредитных карт). Это неверно: он относится к любой системе, которая «хранит, обрабатывает или передаёт» эту информацию. Какие именно требования необходимо соблюдать, зависит от того, какой из методов интеграции с платёжным шлюзом используется. [Руководство Visa по обработке платежей в электронной торговле](https://www.visa.co.uk/dam/VCOM/regional/ve/unitedkingdom/PDF/risk/processing-e-commerce-payments-guide-73-17337.pdf) содержит более подробную информацию об этом, но в виде краткого резюме:

| Метод интеграции | Анкета для самооценки (SAQ) |
|--------------------|-------------------------------------|
| Перенаправление | [SAQ A](https://www.pcisecuritystandards.org/documents/PCI-DSS-v3_2_1-SAQ-A.pdf) |
| IFRAME | [SAQ A](https://www.pcisecuritystandards.org/documents/PCI-DSS-v3_2_1-SAQ-A.pdf) |
| Междоменный POST | [SAQ A-EP](https://www.pcisecuritystandards.org/documents/PCI-DSS-v3_2-SAQ-A_EP-rev1_1.pdf) |
| API | [SAQ D](https://www.pcisecuritystandards.org/documents/PCI-DSS-v3_2_1-SAQ-D_Merchant.pdf) |

Помимо различий в поверхности атаки и профиле риска каждого подхода, существует также значительная разница в количестве требований между SAQ A (22 требования) и SAQ D (329 требований), которым организация должна соответствовать. Таким образом, стоит выделить приложения, которые не используют перенаправление или IFRAME, поскольку они представляют повышенные технические риски и риски несоответствия требованиям.

### Подделка количества

Большинство web-сайтов электронной коммерции позволяют пользователям добавлять покупки в корзину до начала процесса оплаты заказа. Корзина помогает отслеживать, какие продукты или услуги были добавлены, и в каком количестве. Количество обычно должно быть положительным целым числом, но если web-сайт это должным образом не контролирует, то можно указать дробное (например, `0,1`) и/или отрицательное (например, `-1`) количество. В зависимости от обработки в серверной части добавление отрицательного количества товара может привести к отрицательной сумме, уменьшая общую стоимость корзины.

Обычно существует несколько способов изменения содержимого корзины, которые следует протестировать, например:

- Добавление отрицательного количества товара.
- Многократное удаление товара, пока его количество не станет отрицательным.
- Изменение количества на отрицательное значение.

Некоторые сайты могут также предоставлять выпадающее меню с указанием допустимых количеств (например, товаров, которые необходимо покупать в упаковках по 10 штук), и можно подделать эти запросы, чтобы добавить другие количества товаров.

Если платёжному шлюзу передаётся полная информация о корзине (а не только её общая стоимость), на этом этапе также возможно подделать значения.

Наконец, если приложение уязвимо к [загрязнению HTTP-параметров](../07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution.md), то можно вызвать неожиданное поведение, передавая параметр несколько раз, например:

```http
POST /api/basket/add
Host: example.org

item_id=1&quantity=5&quantity=4
```

### Подделка цен

#### В приложении

При добавлении товара в корзину приложение должно включать в запрос только товар и количество, как в примере ниже:

```http
POST /api/basket/add HTTP/1.1
Host: example.org

item_id=1&quantity=5
```

Однако в некоторых случаях запрос может также включать цену, что означает, что её можно подделать:

```http
POST /api/basket/add HTTP/1.1
Host: example.org

item_id=1&quantity=5&price=2.00
```

Разные типы товаров могут иметь разные правила контроля, поэтому каждый тип необходимо тестировать отдельно. Некоторые приложения также позволяют пользователям включать дополнительное пожертвование на благотворительность в рамках своей покупки, и его сумма обычно может быть произвольной. Если эта сумма не контролируется, то можно указать отрицательное значение, что уменьшит общую стоимость корзины.

#### На платёжном шлюзе

Если процесс оплаты заказа проводится на стороннем платёжном шлюзе, возможна подделка цены между приложением и шлюзом.

Передача на шлюз может быть выполнена с помощью междоменного POST-запроса, как показано в примере HTML ниже.

> Примечание. Данные карты не включаются в этот запрос — пользователю будет предложено ввести их на платёжном шлюзе:

```html
<form action="https://example.org/process_payment" method="POST">
    <input type="hidden" id="merchant_id" value="123" />
    <input type="hidden" id="basket_id" value="456" />
    <input type="hidden" id="item_id" value="1" />
    <input type="hidden" id="item_quantity" value="5" />
    <input type="hidden" id="item_total" value="20.00" />
    <input type="hidden" id="shipping_total" value="2.00" />
    <input type="hidden" id="basket_total" value="22.00" />
    <input type="hidden" id="currency" value="GBP" />
    <input type="submit" id="submit" value="submit" />
</form>
```

Изменяя HTML-форму или перехватив POST-запрос, можно изменить цены на товары и с успехом покупать их дешевле. Обратите внимание, что многие платёжные шлюзы отклоняют транзакцию с нулевым значением, поэтому итоговая сумма 0,01 с большей вероятностью будет успешной. Однако некоторые платёжные шлюзы могут принимать отрицательные значения (используются для обработки возвратов). Там, где есть несколько значений (например, цены товаров, стоимость доставки и общая стоимость корзины), все они должны быть протестированы.

Если вместо этого платёжный шлюз использует IFRAME, можно провести аналогичный тип атаки, изменив его URL:

```html
<iframe src="https://example.org/payment_iframe?merchant_id=123&basket_total=22.00" />
```

> Примечание: Платёжные шлюзы обычно принадлежат сторонним организациям и поэтому не могут входить в область тестирования. Это означает, что, хотя подделка цены может быть приемлемой, другие типы атак (например, SQL-инъекция) не должны проводиться без явного письменного разрешения владельца шлюза).

#### Зашифрованные сведения о транзакциях

Чтобы предотвратить подделку транзакции, некоторые платежные шлюзы шифруют детали запроса, который им направляется. Например, [Paypal](https://developer.paypal.com/api/nvp-soap/paypal-payments-standard/integration-guide/encryptedwebpayments/#link-usingewptoprotectmanuallycreatedpaymentbuttons) делает это с помощью криптографии с открытым ключом.

Первое, что нужно попробовать, — сделать незашифрованный запрос, так как некоторые платёжные шлюзы допускают незащищённые транзакции, если они не были специально настроены, чтобы их отклонять.

Если это не сработает, нужно найти открытый ключ, который используется для шифрования сведений о транзакции, который можно найти в резервной копии приложения, или если сможете найти уязвимость обхода каталогов.

В качестве альтернативы возможно, что приложение переиспользует одну и ту же пару открытого и закрытого ключей для платёжного шлюза и его сертификата. Вы можете получить открытый ключ с сервера с помощью следующей команды:

```bash
echo -e '\0' | openssl s_client -connect example.org:443 2>/dev/null | openssl x509 -pubkey -noout
```

Получив этот ключ, вы можете попытаться создать зашифрованный запрос (на основе документации платёжного шлюза) и передать его на шлюз, чтобы узнать, принят ли он.

#### Защищённый хэш

Другие платежные шлюзы используют защищённый хэш (или HMAC) сведений о транзакциях для предотвращения несанкционированного доступа. Детали реализации у разных поставщиков будут различаться (например, [Adyen](https://docs.adyen.com/online-payments/classic-integrations/hosted-payment-pages/hmac-signature-calculation) использует HMAC-SHA256), но обычно они включают в себя сведения о транзакции и секретное значение. Например, хэш может быть вычислен как:

```php
$secure_hash = md5($merchant_id . $transaction_id . $items . $total_value . $secret)
```

Затем это значение добавляется к POST-запросу, который отправляется платёжному шлюзу, и сверяется, чтобы убедиться, что транзакция не была подделана.

Первое, что нужно попробовать, — удалить это хэш, поскольку некоторые платёжные шлюзы допускают незащищённые транзакции, если не установлен определённый параметр конфигурации.

POST-запрос должен содержать все значения, необходимые для вычисления хэша, кроме секретного ключа. Это означает, что если вы знаете, как вычисляется хэш (что должно быть описано в документации платёжного шлюза), то вы можете попытаться взломать этот секрет методом перебора. В качестве альтернативы, если на web-сайте запущено готовое приложение, секрет по умолчанию может находиться в файлах конфигурации или в исходном коде. Наконец, если вы сможете найти резервную копию web-сайта или иным образом получить доступ к файлам конфигурации, вы можете найти секрет там.

Если вам удастся получить этот секрет, вы сможете подделать сведения о транзакции, а затем сгенерировать свой собственный защищённый хэш, который будет приниматься платёжным шлюзом.

#### Подделка валюты

Если невозможно изменить фактические цены, возможно, удастся изменить используемую валюту, особенно если приложения поддерживают несколько валют. Например, приложение может проверить, что цена равна 10, но если вы можете изменить валюту так, чтобы платить 10 долларов США, а не 10 фунтов стерлингов, это позволит вам приобретать товары дешевле.

#### Запросы с задержкой по времени

Если стоимость товаров на сайте меняется с течением времени (например, при обмене валюты), то можно купить или продать по старой цене, перехватывая запросы с использованием локального прокси и задерживая их. Для того, чтобы это можно было эксплуатировать, цена должна быть либо включена в запрос, либо связана с чем-то в запросе (например, с идентификатором сессии или транзакции). Приведённый ниже пример показывает, как это потенциально можно эксплуатировать в приложении, которое позволяет пользователям покупать и продавать золото:

- Посмотреть текущую цену золота на сайте.
- Инициировать запрос на покупку одной унции золота.
- Перехватить и зафиксировать запрос.
- Подождать одну минуту, чтобы снова проверить цену на золото:
    - Если она увеличится, завершить транзакцию и купить золото дешевле, чем его текущая стоимость.
    - Если она уменьшится, отменить запрос.

Если сайт позволяет пользователю совершать платежи в криптовалютах (которые обычно гораздо более волатильны), то можно попробовать получить фиксированную цену в этой криптовалюте, а затем подождать наблюдая, увеличится или упадёт стоимость по сравнению с основной валютой, используемой сайтом.

### Промокоды

Если приложение поддерживает промокоды, то необходимо провести различные проверки:

- Легко ли угадать код (TEST, TEST10, SORRY, SORRY10, название компании, праздника и т.д.)?
    - Если в коде есть номер, можно ли найти другие коды, меняя номер?
- Есть ли защита от перебора?
- Можно ли применить сразу несколько промокодов?
- Можно ли применять промокоды несколько раз?
- Можно ли [вставить символы подстановки](../07-Input_Validation_Testing/05-Testing_for_SQL_Injection.md#SQL-инъекция-с-символами-подстановки), например, `%` или `*`?
- Нет ли промокодов в исходном HTML или в скрытых полях формы `<input>` где-либо в приложении?

Кроме того следует проверить наличие обычных уязвимостей, таких как SQL-инъекции.

### Нарушение процесса оплаты

Если процесс оформления заказа или оплаты в приложении включает в себя несколько этапов (например, добавление товаров в корзину, ввод промокодов, ввод сведений о доставке и платёжной информации), то проведение этих этапов вне ожидаемой последовательности может привести к неожиданному поведению. Например, можно попробовать:

- Изменить адрес доставки после ввода платёжных реквизитов для снижения стоимости доставки.
- Удалить товары после ввода сведений о доставке, чтобы избежать ограничения на минимальную стоимость корзины.
- Изменить содержимое корзины после применения промокода.
- Изменить содержимое корзины после завершения процесса оформления заказа.

Также можно пропустить весь процесс оплаты транзакции. Например, если приложение перенаправляет на сторонний платёжный шлюз, то последовательность операций может быть следующей:

- Пользователь вводит данные в приложение.
- Пользователь перенаправляется на сторонний платёжный шлюз.
- Пользователь вводит данные своей карты.
    - Если платёж прошел успешно, он перенаправляется на `success.php` в приложении.
    - Если платеж не прошёл, он перенаправляется на `failure.php` в приложении.
- Приложение обновляет свою базу данных заказов и обрабатывает заказ, если он был выполнен успешно.

В зависимости от того, подтверждает ли приложение, что платёж на шлюзе был успешным, можно принудительно заставить перейти на страницу `success.php` (с идентификатором транзакции, если он требуется), что приведёт к тому, что сайт обработает заказ, как если бы оплата прошла успешно. Кроме того, можно сделать повторные запросы к странице `success.php`, чтобы заставить заказ обрабатываться несколько раз.

### Комиссии за обработку транзакций

Продавцы обычно должны платить комиссию за каждую обработанную транзакцию, которая как правило состоит из небольшой фиксированной суммы и процента от общей стоимости. Это означает, что получение минимальных платежей (например, $0,01) может привести к фактической потере денег продавцом, поскольку плата за обработку транзакции превышает её общую стоимость.

Эта уязвимость редко эксплуатируется на сайтах электронной коммерции, поскольку цена самого дешёвого товара обычно достаточно велика, чтобы её предотвратить. Однако, если сайт позволяет клиентам совершать платежи с произвольными суммами (например, пожертвования), убедитесь, что он ограничивает их разумной минимальной суммой.

### Номера тестовых карт

У большинства платежных шлюзов определён набор реквизитов для тестовой карты, которые могут использоваться разработчиками во время тестирования и отладки. Они должны использоваться только в версиях шлюзов для разработки или в изолированной среде (англ.: sandbox), но могут быть приняты на действующих сайтах, если они неправильно сконфигурированы.

Примеры тестовых карт для различных платёжных шлюзов перечислены ниже:

- [Adyen - Test Card Numbers](https://docs.adyen.com/development-resources/test-cards/test-card-numbers)
- [Globalpay - Test Cards](https://developer.globalpay.com/resources/test-card-numbers)
- [Stripe - Basic Test Card Numbers](https://stripe.com/docs/testing#cards)
- [Worldpay - Test Card Numbers](http://support.worldpay.com/support/kb/bg/testandgolive/tgl5103.html)

### Логистика тестирования

Тестирование функций оплаты в приложениях может привести к дополнительным сложностям, особенно если тестируется работающий сайт. Действия, которые необходимо учитывать, включают:

- Получить платёжные реквизиты тестовой карты для приложения.
    - Если их нет, то можно получить предоплаченную и т.п. карту.
- Вести журнал всех сделанных заказов, чтобы их можно было отменить и вернуть деньги.
- Не размещать заказы, которые нельзя отменить или которые повлекут за собой другие действия (например, немедленную отправку товаров со склада).

## Связанные сценарии тестирования

- [Тестирование загрязнения параметров HTTP](../07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution.md)
- [Тестирование SQL-инъекций](../07-Input_Validation_Testing/05-Testing_for_SQL_Injection.md)
- [Тестирование обхода потока операций](06-Testing_for_the_Circumvention_of_Work_Flows.md)

## Меры защиты

- По возможности избегайте хранения, передачи или обработки данных карты.
    - Используйте перенаправление или IFRAME для платёжного шлюза.
- Ознакомьтесь с документацией платёжного шлюза и используйте все имеющиеся функции безопасности (такие как шифрование и защищённый хэш).
- Обрабатывайте всю информацию, относящуюся к ценам, на стороне сервера:
    - На стороне клиента запросы должны включать только идентификаторы товаров и их количество.
- Реализуйте соответствующий контроль входных данных и ограничения бизнес-логики (например, проверку на отрицательное количество товара или сумму оплаты).
- Убедитесь, что процесс оплаты в приложении является надёжным и что его этапы не могут выполняться не по порядку.

## Ссылки

- [Payment Card Industry Data Security Standard (PCI DSS)](https://docs-prv.pcisecuritystandards.org/PCI%20DSS/Standard/PCI_DSS_v3-2-1_RU.pdf)
- [Visa Processing E-Commerce Payments guidance](https://www.visa.co.uk/dam/VCOM/regional/ve/unitedkingdom/PDF/risk/processing-e-commerce-payments-guide-73-17337.pdf)
