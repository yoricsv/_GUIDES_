---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование XPath-инъекций

|ID          |
|------------|
|WSTG-INPV-09|

## Обзор

XPath — это язык, который был разработан в первую очередь для обращения к частям XML-документа. При тестировании XPath-инъекций мы проверяем, возможно ли ввести синтаксис XPath в запрос, интерпретируемый приложением, позволяя злоумышленнику выполнять пользовательские XPath-запросы. При успешной эксплуатации эта уязвимость может позволить злоумышленнику обойти механизмы аутентификации или получить доступ к информации без надлежащей авторизации.

Web-приложения активно используют базы данных для хранения и доступа к данным, необходимым им для работы. Исторически реляционные базы данных были наиболее распространённой технологией хранения данных, но в последние годы мы наблюдаем растущую популярность баз данных, которые организуют данные с использованием языка XML. Так же, как доступ к реляционным базам данных осуществляется через язык SQL, базы данных XML используют XPath в качестве стандартного языка запросов.

Поскольку с концептуальной точки зрения XPath очень похож на SQL по своему назначению и приложениям, интересным результатом является то, что атаки с XPath-инъекциями следуют той же логике, что и атаки с [SQL-инъекциями](https://owasp.org/www-community/attacks/SQL_Injection). В некоторых аспектах XPath даже мощнее, чем стандартный SQL, поскольку вся его мощь уже заложена в его спецификациях, в то время как большинство методов, которые могут эксплуатироваться в SQL-инъекциях, зависят от диалекта SQL, используемого целевой базой данных. Это означает, что атаки с XPath-инъекциями могут быть гораздо более адаптируемыми и повсеместными. Ещё одно преимущество атаки с XPath заключается в том, что, в отличие от SQL, не применяются списки управления доступом (ACL), поскольку запрос может получить доступ к любой части XML-документа.

## Задача тестирования

- Найти точки для инъекции XPath.

## Как тестировать

[Шаблон атаки XPath был впервые опубликован Амитом Кляйном](http://dl.packetstormsecurity.net/papers/bypass/Blind_XPath_Injection_20040518.pdf) и очень похож на обычную SQL-инъекцию. Чтобы получить первое представление о проблеме, давайте представим страницу входа, которая управляет аутентификацией в приложении, в котором пользователь должен ввести своё имя и пароль. Давайте предположим, что наша база данных представлена следующим XML-файлом:

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<users>
    <user>
        <username>gandalf</username>
        <password>!c3</password>
        <account>admin</account>
    </user>
    <user>
        <username>Stefan0</username>
        <password>w1s3c</password>
        <account>guest</account>
    </user>
    <user>
        <username>tony</username>
        <password>Un6R34kb!e</password>
        <account>guest</account>
    </user>
</users>
```

XPath-запрос, который выдаёт учётную запись, имя пользователя которой `gandalf`, а пароль `!c3`, будет следующим:

`string(//user[username/text()='gandalf' and password/text()='!c3']/account/text())`

Если приложение неправильно фильтрует вводимые пользователем данные, тестировщик сможет ввести код XPath и повлиять на результат запроса. Например, тестировщик мог бы ввести следующие значения:

```text
Username: ' or '1' = '1
Password: ' or '1' = '1
```

Выглядит довольно знакомо, не так ли? Используя эти параметры, получается запрос:

`string(//user[username/text()='' or '1' = '1' and password/text()='' or '1' = '1']/account/text())`

Как и в обычной атаке SQL-инъекцией, мы создали запрос, который всегда оценивается как true, что означает, что приложение будет аутентифицировать пользователя, даже если имя пользователя или пароль не были предоставлены. И, как и при обычной атаке SQL-инъекцией, при инъекции XPath первым шагом является вставка одинарной кавычки (`'`) в поле, подлежащее проверке, что приводит к синтаксической ошибке в запросе, и к проверке: выдаёт ли приложение сообщение об ошибке.

Если сведения о внутреннем устройстве XML отсутствуют, и приложение не предоставляет полезных сообщений об ошибках, которые помогли бы восстановить его внутреннюю логику, можно провести атаку [слепой XPath-инъекции](https://owasp.org/www-community/attacks/Blind_XPath_Injection), целью которой является восстановление полной структуры данных. Этот метод аналогичен SQL-инъекции на основе логического вывода, поскольку подход заключается во вставке кода, который создаёт запрос, возвращающий один бит информации. [Слепая XPath-инъекция](https://owasp.org/www-community/attacks/Blind_XPath_Injection) более подробно объясняется Амитом Кляйном в упомянутой статье.

## Ссылки

### Технические руководства

- [Amit Klein: "Blind XPath Injection"](http://dl.packetstormsecurity.net/papers/bypass/Blind_XPath_Injection_20040518.pdf)
- [Спецификации XPath](https://www.w3.org/TR/xpath/)
