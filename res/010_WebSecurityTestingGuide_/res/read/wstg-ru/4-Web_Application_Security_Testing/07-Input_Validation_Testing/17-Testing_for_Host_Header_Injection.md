---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование инъекций в заголовке Host

|ID          |
|------------|
|WSTG-INPV-17|

## Обзор

Web-сервер обычно размещает несколько web-приложений на одном IP-адресе, обращаясь к каждому приложению через виртуальный хост. Во входящем HTTP-запросе web-серверы часто отправляют запрос целевому виртуальному хосту на основе значения, указанного в заголовке Host. Без надлежащей проверки значения заголовка злоумышленник может ввести некорректные входные данные, чтобы заставить web-сервер:

- Отправлять запросы на первый виртуальный хост в списке.
- Выполнять перенаправление на домен, контролируемый злоумышленником.
- Проводить отравление web-кэша.
- Манипулировать функцией сброса пароля.
- Разрешать доступ к виртуальным хостам, которые не предназначены для внешнего доступа.

## Задачи тестирования

- Оценить, выполняется ли динамический парсинг заголовка Host в приложении.
- Обойти меры защиты, которые полагаются на этот заголовок.

## Как тестировать

Первоначальное тестирование — просто указать другой домен (например, `attacker.com`) в поле заголовка Host. Именно то, как web-сервер обрабатывает значение заголовка, определяет воздействие. Атака сработала, если web-сервер обрабатывает входные данные для отправки запроса на контролируемый злоумышленником хост, который находится в указанном домене, а не на внутренний виртуальный хост, который находится на web-сервере.

```http
GET / HTTP/1.1
Host: www.attacker.com
[...]
```

В простейшем случае это может привести к перенаправлению на указанный домен.

```http
HTTP/1.1 302 Found
[...]
Location: http://www.attacker.com/login.php

```

В качестве альтернативы web-сервер может отправить запрос на первый виртуальный хост в списке.

### Обход заголовка X-Forwarded-Host

В случае, если инъекция заголовка Host компенсируется путём проверки недопустимых входных данных, введённых через заголовок Host, вы можете указать значение в заголовке `X-Forwarded-Host`.

```http
GET / HTTP/1.1
Host: www.example.com
X-Forwarded-Host: www.attacker.com
[...]
```

Потенциально выдаст на стороне клиента что-то подобное:

```html
[...]
<link src="http://www.attacker.com/link" />
[...]
```

Опять же, это зависит от того, как web-сервер обрабатывает значение заголовка.

### Отравление web-кэша

Используя этот метод, злоумышленник может манипулировать web-кэшем, чтобы предоставить заражённый контент всем, кто его запрашивает. Это зависит от способности отравлять кэширующий прокси, установленный на самом приложении, CDN или у других нижестоящих поставщиков. В результате жертва не сможет контролировать получение вредоносного контента при запросе уязвимого приложения.

```http
GET / HTTP/1.1
Host: www.attacker.com
[...]
```

Когда жертва посещает уязвимое приложение, ей из web-кэша будет выдано:

```html
[...]
<link src="http://www.attacker.com/link" />
[...]
```

### Отравление при сбросе пароля

Обычно функция сброса пароля включает значение заголовка Host при создании ссылок для сброса пароля, использующих сгенерированный секретный токен. Если приложение обрабатывает контролируемый злоумышленником домен для создания ссылки для сброса пароля, жертва может перейти по ссылке в письме электронной почты и позволить злоумышленнику получить токен сброса, тем самым сбросив свой пароль.

В приведённом ниже примере показана ссылка для сброса пароля, которая генерируется в PHP с использованием значения `$_SERVER['HTTP_HOST']`, которое устанавливается на основе содержимого HTTP-заголовка Host:

```php
$reset_url = "https://" . $_SERVER['HTTP_HOST'] . "/reset.php?token=" .$token;
send_reset_email($email,$reset_url);
```

Сделав HTTP-запрос на страницу сброса пароля с подделанным заголовком Host, мы можем изменить домен, на который указывает URL:

```http
POST /request_password_reset.php HTTP/1.1
Host: www.attacker.com
[...]

email=user@example.org
```

Указанный домен (`www.attacker.com `) затем будет использоваться в ссылке сброса, которая отправляется пользователю по электронной почте. Когда пользователь переходит по этой ссылке, злоумышленник может украсть токен и скомпрометировать его учётную запись.

```text
... фрагмент письма ...

Перейдите по следующей ссылке, чтобы сбросить свой пароль:

https://www.attacker.com/reset.php?token=12345

... фрагмент письма ...
```

### Доступ к частным виртуальным хостам

В некоторых случаях сервер может иметь виртуальные хосты, которые не предназначены для внешнего доступа. Чаще всего это происходит при настройке [split-horizon DNS](https://en.wikipedia.org/wiki/Split-horizon_DNS) (где внутренние и внешние DNS-серверы возвращают разные записи для одного и того же домена в зависимости от подсети источника запроса).

Например, у организации может быть один web-сервер во внутренней сети, на котором размещены как её общедоступный web-сайт (`www.example.org`), так и внутренняя сеть (`intranet.example.org`, но эта запись есть только во внутреннем DNS-сервере). Несмотря на то, что невозможно перейти непосредственно к `intranet.example.org` за периметром сети (поскольку домен не будет разрешён), можно получить доступ к внутренней сети, сделав запрос извне со следующим заголовком `Host`:

```http
Host: intranet.example.org
```

Этого также можно добиться, добавив запись для `intranet.example.org` в файл hosts с публичным IP-адресом `www.example.org`, или переопределив разрешения доменных имён DNS в вашем инструменте тестирования.

## Ссылки

- [What is a Host Header Attack?](https://www.acunetix.com/blog/articles/automated-detection-of-host-header-attacks/)
- [Host Header Attack](https://www.briskinfosec.com/blogs/blogsdetail/Host-Header-Attack)
- [HTTP Host header attacks](https://portswigger.net/web-security/host-header)
