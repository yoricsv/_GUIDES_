---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование LDAP-инъекций

|ID          |
|------------|
|WSTG-INPV-06|

## Обзор

Облегченный протокол доступа к каталогам (англ.: Lightweight Directory Access Protocol, LDAP) используется для хранения информации о пользователях, хостах и многих других объектах. [LDAP-инъекция](https://owasp.org/www-community/attacks/LDAP_Injection) — это атака на стороне сервера, которая делает возможными разглашение, изменение или вставку конфиденциальной информации о пользователях и хостах, представленных в структуре LDAP. Это делается путем манипулирования входными параметрами, которые затем передаются во внутренние функции поиска, добавления и изменения.

Web-приложение может использовать LDAP для того, чтобы позволить пользователям проходить аутентификацию или искать информацию о других пользователях внутри корпоративной структуры. Целью атак LDAP-инъекций является вставка метасимволов поисковых фильтров LDAP в запрос, который будет выполняться приложением.

[RFC2254](https://www.ietf.org/rfc/rfc2254.txt) определяет грамматику построения фильтра поиска в LDAPv3 и расширяет [RFC1960](https://www.ietf.org/rfc/rfc1960.txt) (LDAPv2).

Фильтр поиска LDAP строится в польской записи, также известной как [префиксная нотация](https://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D0%BB%D1%8C%D1%81%D0%BA%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C).

Это означает, что условие псевдокода в поисковом фильтре, например,

`find("cn=John & userPassword=mypass")`

будет выглядеть так:

`find("(&(cn=John)(userPassword=mypass))")`

Логические условия и групповые агрегации в фильтре поиска LDAP можно применять с помощью следующих метасимволов:

| Метасимвол |  Значение              |
|----------|-----------------------|
| &        |  Логическое И          |
| \|       |  Логическое ИЛИ           |
| !        |  Логическое НЕ          |
| =        |  Равно               |
| ~=       |  Приблизительно равно  |
| >=       |  Больше         |
| <=       |  Меньше            |
| *        |  Любой символ        |
| ()       |  Группирующие скобки |

Более полные примеры создания фильтра поиска можно найти в соответствующем RFC.

Успешная эксплуатация уязвимости LDAP-инъекции может позволить тестировщику:

- несанкционированный доступ к контенту;
- обходить ограничения приложения;
- несанкционированный сбор информации;
- добавлять или изменять объекты внутри древовидной структуры LDAP.

## Задачи тестирования

- Определите точки инъекции LDAP.
- Оценить воздействие инъекции.

## Как тестировать

### Пример 1: Фильтры поиска

Предположим, у нас есть web-приложение, использующее фильтр поиска, например:

`searchfilter="(cn="+user+")"`

который создается HTTP-запросом, подобным такому:

`http://www.example.com/ldapsearch?user=John`

Если значение `John` заменить на `*`, отправив запрос:

`http://www.example.com/ldapsearch?user=*`

фильтр будет выглядеть так:

`searchfilter="(cn=*)"`

который соответствует объектам с любым атрибутом 'cn'.

Если приложение уязвимо для LDAP-инъекции, оно будет отображать некоторые или все атрибуты пользователя, в зависимости от потока выполнения приложения и разрешений пользователя, подключенного к LDAP.

Тестировщик может использовать метод проб и ошибок, вставляя в параметр `(`, `|`, `&`, `*` и другие символы, чтобы проверить приложение на наличие ошибок.

### Пример 2: Вход в систему

Если web-приложение использует LDAP для проверки учётных данных пользователя в процессе входа в систему и оно уязвимо для LDAP-инъекции, можно обойти аутентификацию, введя всегда истинный LDAP-запрос (аналогично SQL- и XPATH-инъекциям).

Предположим, что web-приложение использует фильтр для сопоставления пары пользователь/пароль в LDAP.


`searchlogin= "(&(uid="+user+")(userPassword={MD5}"+base64(pack("H*",md5(pass)))+"))";`

Со следующими значениями:

```txt
user=*)(uid=*))(|(uid=*
pass=password
```

поисковый фильтр будет:

`searchlogin="(&(uid=*)(uid=*))(|(uid=*)(userPassword={MD5}X03MO1qnZdYdgyfeuILPmQ==))";`

что корректно и всегда истинно. Таким образом, тестировщик получит статус первого пользователя в дереве LDAP.

## Инструменты

- [Softerra LDAP Browser](https://www.ldapadministrator.com)

## Ссылки

- [Памятка по предотвращению LDAP-инъекций](https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html)

### Технические руководства

- [Sacha Faust: LDAP Injection: Are Your Applications Vulnerable?](http://www.networkdls.com/articles/ldapinjection.pdf)
- [IBM paper: Understanding LDAP](https://www.redbooks.ibm.com/redbooks/pdfs/sg244986.pdf)
- [RFC 1960: A String Representation of LDAP Search Filters](https://www.ietf.org/rfc/rfc1960.txt)
- [LDAP injection](https://www.blackhat.com/presentations/bh-europe-08/Alonso-Parada/Whitepaper/bh-eu-08-alonso-parada-WP.pdf)
