---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование безопасности транспортного уровня (TLS)

|ID          |
|------------|
|WSTG-CRYP-01|

## Обзор

Когда информация передается между клиентом и сервером, она должна быть зашифрована и защищена, чтобы злоумышленник не смог ее прочитать или изменить. Чаще всего это делается с помощью HTTPS, который использует протокол безопасности транспортного уровня (англ.: [Transport Layer Security, TLS](https://ru.wikipedia.org/wiki/TLS)), который пришёл на замену более старому протоколу Secure Socket Layer (SSL). Протокол TLS также предоставляет серверу возможность продемонстрировать клиенту, что он подключился к правильному серверу, представив доверенный сертификат.

За прошедшие годы было выявлено большое количество криптографических уязвимостей в протоколах SSL и TLS, а также в используемых ими шифрах. Кроме того, многие реализации этих протоколов также имели серьёзные уязвимости. Таким образом, важно проверить, что сайты не просто реализуют TLS, но и делают это безопасным образом.

## Задачи тестирования

- Проверить конфигурацию протокола.
- Проанализировать криптографическую стойкость и доверие сертификату.
- Убедиться, что криптозащита TLS не поддаётся обходу и должным образом реализована во всём приложении.

## Как тестировать

Вопросы, связанные с безопасностью транспортного уровня, можно в целом разделить на следующие области:

### Конфигурация сервера

Существует большое количество версий, шифров и расширений протокола, поддерживаемых TLS. Многие из них считаются устаревшими и имеют криптографические уязвимости, перечисленные ниже. Обратите внимание, что со временем, вероятно, будут выявляться новые уязвимости, поэтому этот список может быть неполным.

- [SSLv2 (DROWN)](https://drownattack.com/)
- [SSLv3 (POODLE)](https://ru.wikipedia.org/wiki/POODLE)
- [TLSv1.0 (BEAST)](https://crashtest-security.com/ssl-beast-attack-tls/)
- [TLSv1.1 (осуждается в RFC 8996)](https://datatracker.ietf.org/doc/html/rfc8996)
- [Экспортные шифронаборры RSA (FREAK)](https://ru.wikipedia.org/wiki/FREAK)
- [NULL-шифры](https://www.rapid7.com/db/vulnerabilities/ssl-null-ciphers) ([обеспечивают только аутентификацию](https://datatracker.ietf.org/doc/html/rfc4785)).
- Анонимные шифры (могут поддерживаться на SMTP-серверах, как описано в [RFC 7672](https://datatracker.ietf.org/doc/html/rfc7672#section-8.2))
- [Шифры RC4 (NOMORE)](https://www.rc4nomore.com/)
- Шифры в режиме CBC (BEAST, [Lucky 13](https://en.wikipedia.org/wiki/Lucky_Thirteen_attack))
- [Сжатие данных в TLS (CRIME)](https://en.wikipedia.org/wiki/CRIME)
- [Уязвимые ключи DHE (LOGJAM)](https://weakdh.org/)

В [Руководстве Mozilla по TLS на стороне сервера](https://wiki.mozilla.org/Security/Server_Side_TLS) подробно описаны протоколы и шифры, которые рекомендуются в настоящее время.

#### Эксплуатируемость

Следует подчеркнуть, что, хотя многие из этих атак были продемонстрированы в лабораторных условиях, их обычно не считают практичными для использования в реальном мире, поскольку они требуют (уже действующей) MitM-атаки и значительных ресурсов. Как таковые, они вряд ли будут эксплуатироваться кем-либо, кроме государственных спецслужб.

### Сертификаты

#### Криптографические уязвимости

С криптографической точки зрения, есть две основные области, которые необходимо рассмотреть в отношении сертификатов:

- Стойкость ключа должна составлять *не менее* 2048 бит.
- Алгоритм подписи должен быть *хотя бы* SHA-256. Не следует использовать устаревшие алгоритмы, такие как MD5 и SHA-1.

#### Достоверность

Помимо криптографической защиты, сертификат также должен считаться действительным (или доверенным). Это означает, что он должен:

- Быть в пределах указанного срока действия.
    - Максимальный срок действия сертификатов, выданных после 1 сентября 2020 года, не должен превышать [398 дней](https://blog.mozilla.org/security/2020/07/09/reducing-tls-certificate-lifespans-to-398-days/).
- Быть подписанным доверенным удостоверяющим центром (или сокращённо, УЦ, англ.: certificate authority, CA).
    - Это должен быть либо доверенный общедоступный УЦ для внешних приложений, либо внутренний УЦ (например, предприятия) для собственных приложений.
    - Не считайте сертификаты внутренних приложений недоверенными только потому, что *ваша* система не доверяет УЦ.
- Иметь альтернативное имя субъекта (англ.: Subject Alternate Name, SAN), которое соответствует имени хоста системы.
    - Поле Common Name (CN) игнорируется современными браузерами, которые смотрят только на SAN.
    - Убедитесь, что вы обращаетесь к системе с корректным именем (например, если вы обращаетесь к хосту по IP, то любой сертификат будет отображаться как недоверенный).

Некоторые сертификаты могут быть выданы для доменов с подстановочными символами (например, `*.example.org `), что означает, что они могут быть действительны для нескольких поддоменов. Несмотря на удобство, существует ряд проблем безопасности, связанных с этим, которые следует учитывать. Они обсуждаются в [Памятке OWASP по безопасности транспортного уровня](https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html#carefully-consider-the-use-of-wildcard-certificates).

Сертификаты также могут привести к утечке информации о внутренних системах или доменных именах в полях Issuer и SAN, что может быть полезно для того, чтобы составить представление об устройстве внутренней сети или при проведении мероприятий по социальной инженерии.

### Уязвимости реализации

На протяжении многих лет в различных реализациях TLS проявлялись уязвимости. Их слишком много, чтобы перечислять все, вот некоторые из основных:

- [Предсказуемый генератор случайных чисел в Debian OpenSSL](https://www.debian.org/security/2008/dsa-1571) (CVE-2008-0166)
- [Небезопасное пересогласование условий подключения в OpenSSL](https://www.openssl.org/news/secadv/20091111.txt) (CVE-2009-3555)
- [OpenSSL Heartbleed](https://heartbleed.com) (CVE-2014-0160)
- [F5 TLS POODLE](https://support.f5.com/csp/article/K15882) (CVE-2014-8730)
- [Отказ в обслуживании Microsoft Schannel](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2014/ms14-066) (MS14-066 / CVE-2014-6321)

### Уязвимости приложений

Помимо безопасной настройки базовой конфигурации TLS, приложение также должно использовать её безопасным способом. Некоторые из этих пунктов рассматриваются в других разделах данного Руководства:

- [Не отправлять конфиденциальную информацию по незашифрованным каналам (WSTG-CRYP-03)](03-Testing_for_Sensitive_Information_Sent_via_Unencrypted_Channels.md)
- [Устанавливать заголовок HTTP Strict-Transport-Security (WSTG-CONF-07)](../02-Configuration_and_Deployment_Management_Testing/07-Test_HTTP_Strict_Transport_Security.md)
- [Устанавливать атрибут Secure для файлов cookie (WSTG-SESS-02)](../06-Session_Management_Testing/02-Testing_for_Cookies_Attributes.md)

#### Смешанный активный контент

Смешанный активный контент — это когда активные ресурсы (например, скрипты и CSS) загружаются по незашифрованному HTTP и включаются в защищённую (HTTPS) страницу. Это опасно, потому что это позволяет злоумышленнику изменять эти файлы (поскольку они отправляются в незашифрованном виде), что может позволить им выполнить произвольный код (JavaScript или CSS) на странице. Пассивное содержимое (например, изображения), загруженное через незащищённое соединение, также может привести к утечке информации или позволить злоумышленнику исказить (deface) страницу, хотя это с меньшей вероятностью приведёт к полной компрометации.

> Примечание: современные браузеры блокируют загрузку активного контента из незащищённых источников на защищённые страницы.

#### Перенаправление с HTTP на HTTPS

Многие сайты принимают соединения по незашифрованному HTTP, а затем сразу перенаправляют пользователя на защищённую (HTTPS) версию сайта с переадресацией `301 Moved Permanently`. Затем HTTPS-версия сайта устанавливает заголовок `Strict-Transport-Security`, чтобы указать браузеру всегда использовать HTTPS в будущем.

Однако, если злоумышленнику удастся перехватить этот первоначальный запрос, он может перенаправить пользователя на вредоносный сайт или использовать такой инструмент как [sslstrip](https://github.com/moxie0/sslstrip) для перехвата последующих запросов.

Для защиты от этого типа атак сайт должен быть добавлен в [список предварительной загрузки для браузеров](https://hstspreload.org).

## Автоматизированное тестирование

Существует множество инструментов сканирования, которые можно использовать для выявления уязвимостей в конфигурации SSL/TLS, включая как специализированные инструменты, так и сканеры уязвимостей общего назначения. Вот некоторые из наиболее популярных:

- [Nmap](https://nmap.org) (различные скрипты)
- [OWASP O-Saft](https://owasp.org/www-project-o-saft/)
- [sslscan](https://github.com/rbsec/sslscan)
- [sslyze](https://github.com/nabla-c0d3/sslyze)
- [SSL Labs](https://www.ssllabs.com/ssltest/)
- [testssl.sh](https://github.com/drwetter/testssl.sh)

### Ручное тестирование

Также можно провести большинство проверок вручную в командной строке, такими командами как `openssl s_client` или `gnutls-cli` для подключения с определёнными протоколами, шифрами или параметрами.

При подобном тестировании имейте в виду, что версия OpenSSL или GnuTLS, поставляемая с большинством современных систем, может не поддерживать некоторые устаревшие и небезопасные протоколы, такие как SSLv2 или шифры EXPORT. Убедитесь, что ваша версия поддерживает устаревшие версии, прежде чем использовать её для тестирования, иначе вы получите ложноотрицательные результаты.

Также можно провести ограниченное тестирование с помощью web-браузера, поскольку современные браузеры предоставляют подробную информацию о протоколах и шифрах, которые используются в их инструментах разработчика (англ.: DevTools). Они также предоставляют простой способ проверить, считается ли сертификат доверенным, посмотрев, отображается ли вам предупреждение о сертификате.

## Ссылки

- [Памятка OWASP о безопасности транспортного уровня](https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html)
- [Руководство Mozilla по TLS со стороны сервера](https://wiki.mozilla.org/Security/Server_Side_TLS)
- [Руководство по выживанию — TLS/SSL и сертификаты SSL (X.509)](https://www.opennet.ru/docs/RUS/ldap_apacheds/tech/ssl.html)
- [Полное руководство по переходу с HTTP на HTTPS](https://habr.com/ru/post/332294/)
