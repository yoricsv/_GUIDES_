---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование некорректной обработки ошибок

|ID          |
|------------|
|WSTG-ERRH-01|

## Обзор

Все типы приложений (web-приложения, web-серверы, базы данных и т.д.) по различным причинам генерируют ошибки. Разработчики часто игнорируют обработку этих ошибок или отбрасывают мысль о том, что пользователь когда-либо попытается намеренно вызвать ошибку (*например,* вводя символьную строку вместо ожидаемого целого числа). Когда разработчик рассматривает только позитивный путь, он забывает о других возможных входных данных от пользователя, которые код может получить, но не может обработать.

Ошибки иногда возникают в виде:

- трассировки стека,
- тайм-аута сети,
- несоответствия входных данных,
- дампа памяти.

Некорректная обработка ошибок может позволить злоумышленникам:

- Разобраться в API, используемых внутри компании.
- Сопоставить различные сервисы, интегрированные друг с другом, получив представление об используемых внутренних системах и фреймворках, что открывает возможности для цепочки атак.
- Собрать сведения о версиях и типах используемых приложений.
- Сделать систему недоступной, вызвав взаимную блокировку или необрабатываемое исключение, которое отправляет сигнал паники работающему серверу.
- Управлять обходом, если какое-то исключение не ограничено логикой, настроенной только на позитивный путь.

## Задачи тестирования

- Найти вывод по существующим ошибкам.
- Проанализировать различные возвращаемые выходные данные.

## Как тестировать

Ошибки обычно считаются безобидными, поскольку они предоставляют диагностические данные и сообщения, которые могут помочь пользователю понять проблему или разработчику отладить эту ошибку.

Пытаясь ввести неожиданные данные или заставляя систему работать с определёнными крайними случаями и сценариями, система или приложение в большинстве случаев будут выдавать какую-то информацию о том, что происходит внутри, если только разработчики не отключили все возможные ошибки и не выдают какое-то своё (нестандартное) сообщение.

### Web-серверы

Все web-приложения работают на web-сервере, будь то интегрированный или полноценный. Web-приложения должны обрабатывать и анализировать HTTP-запросы, и поэтому web-сервер всегда входит в состав стека. Одними из самых известных web-серверов являются NGINX, Apache и IIS.

Для каждого web-сервера известны типовые сообщения об ошибках и их форматы. Если кто-то не знаком с тем, как они выглядят, поиск в Интернете даст примеры. Ещё один способ — заглянуть в документацию или просто настроить сервер локально и найти ошибки, просмотрев страницы, которые использует web-сервер.

Чтобы вызвать сообщения об ошибках, тестировщик должен:

- Поискать какие-либо файлы и папки, которые нельзя найти (404-я).
- Запросить существующие папки и посмотреть поведение сервера (403-я, пустая страница или содержание каталога).
- Попробуйте отправить запрос, который нарушает [RFC по HTTP](https://datatracker.ietf.org/doc/html/rfc7231). Одним из примеров может быть отправка очень большого пути, нарушение формата заголовков или изменение версии HTTP.
    - Даже если ошибки обрабатываются на уровне приложения, нарушение RFC по HTTP может заставить интегрированный web-сервер проявить себя, поскольку он должен обрабатывать запрос, а разработчики забывают переопределить эти ошибки.

### Applications

Приложения наиболее подвержены появлению широкого спектра сообщений об ошибках, которые включают в себя: трассировки стека, дампы памяти, некорректно обработанные исключения и типовые ошибки. Это происходит из-за того, что приложения в основном создаются на заказ, поэтому разработчикам необходимо наблюдать и обрабатывать все возможные случаи ошибок (или иметь глобальный механизм обнаружения ошибок), также они могут возникать в результате интеграции с другими сервисами.

Чтобы заставить приложение выдавать эти ошибки, тестировщик должен:

1. Определить возможные точки входа, в которых приложение ожидает данные.
2. Проанализироватб ожидаемый тип входных данных (строки, целые числа, JSON, XML и т.д.).
3. Провести фаззинг каждой точки входа на основе предыдущих шагов для получения более сфокусированного сценария тестирования.
   - Фаззинг каждой точки входа со всеми возможными инъекциями — не лучшее решение, если у вас нет неограниченного времени на тестирование и приложение сможет обработать такой объём входных данных.
   - Если фаззинг невозможен, выберите перспективные входные данные, которые имеют наибольшие шансы сломать данный парсер (*например,* закрывающая скобка для тела JSON, большой текст когда ожидается всего пара символов, инъекция CRLF с параметрами, которые могут быть разобраны серверами и форматно-логическим контролем, специальные символы, которые недопустимы в именах файлов и т.д.).
   - Фаззинг с использованием такой полезной нагрузки должен проводиться для каждого типа данных, поскольку иногда интерпретаторы ломаются и вне обработки исключений, определённой разработчиком.
4. Разберитесь с сервисом, который выдаёт сообщения об ошибках, и попытайтесь составить более точный список векторов для фаззинга, чтобы получить больше информации или подробностей об ошибках из этого сервиса (это может быть база данных, отдельный сервис и т.д.).

Сообщения об ошибках иногда являются основным недостатком проектирования систем, особенно в микросервисной архитектуре. Если сервисы должным образом не настроены на обработку ошибок единым и универсальным образом, сообщения об ошибках позволят тестировщику определить, какой сервис какие запросы обрабатывает, и провести более целенаправленную атаку на каждый сервис.

> Тестировщику необходимо внимательно следить за типом ответа. Иногда ошибки возвращаются как 200-е с телом ошибки, иногда скрывают ошибку в 302-й или просто имеют свой способ представления этой ошибки.

## Меры защиты

Для исправления ситуации ознакомьтесь с [мерой C10 из Top 10 мер проактивной защиты](https://owasp.org/www-project-proactive-controls/v3/en/c10-errors-exceptions) ([перевод](https://github.com/OWASP/www-project-proactive-controls/blob/master/v3/Owasp-top-10-proactive-controls-2018-russian.pdf)) и [Памяткой OWASP по обработке ошибок](https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html).

## Тестовый полигон

- [Juice Shop - Обработка ошибок](https://pwning.owasp-juice.shop/part2/security-misconfiguration.html#provoke-an-error-that-is-neither-very-gracefully-nor-consistently-handled)

## Ссылки

- [WSTG: Приложение C - Векторы для фаззинга](../../6-Appendix/C-Fuzz_Vectors.md)
- [Top 10 мер проактивной защиты - C10: Обработка ошибок и исключений](https://owasp.org/www-project-proactive-controls/v3/en/c10-errors-exceptions)
- [ASVS v4 v7.4: Обработка ошибок](https://github.com/OWASP/ASVS/blob/master/4.0/ru/0x15-V7-Error-Logging.md#v74-%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0-%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA)
- [CWE 728 - Improper Error Handling](https://cwe.mitre.org/data/definitions/728.html)
- [Памятка OWASP по обработке ошибок](https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html)
