---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование перехвата сессии

|ID          |
|------------|
|WSTG-SESS-09|

## Обзор

Злоумышленник, получивший доступ к сессионным cookie пользователя, может выдать себя за него, предъявляя эти cookie. Эта атака известна как перехват сессии. При рассмотрении сетевых злоумышленников, т.е. тех, кто может контролировать сеть, используемую жертвой, сессионные cookie могут быть несанкционированно раскрыты злоумышленником по протоколу HTTP. Чтобы предотвратить это, cookie должны быть помечены атрибутом `Secure`, чтобы они передавались только по протоколу HTTPS.

Обратите внимание, что атрибут `Secure` также следует использовать, когда всё web-приложение развёрнуто на HTTPS, в противном случае возможна кража cookie: предположим, что `example.com` полностью развёрнут на HTTPS, но не помечает свои сессионные cookie как `Secure`. При атаке возможна следующая последовательность действий:

1. Жертва отправляет запрос на `http://another-site.com`.
2. Злоумышленник модифицирует соответствующий ответ таким образом, чтобы он вызывал запрос на `http://example.com`.
3. Теперь браузер пытается получить доступ к `http://example.com`.
4. Несмотря на то, что запрос завершается неудачей, сессионные cookie передаются в открытом виде по протоколу HTTP.

Кроме того, перехват сессии можно предотвратить, запретив использование HTTP с помощью [HSTS](https://ru.wikipedia.org/wiki/HSTS). Обратите внимание, что здесь есть тонкость, связанная с определением области действия cookie. В частности, требуется полноценная реализация HSTS, когда сессионные cookie выдаются с атрибутом `Domain`.

Полноценная реализация HSTS описана в статье *Testing for Integrity Flaws in Web Sessions* Stefano Calzavara, Alvise Rabitti, Alessio Ragazzo, и Michele Bugliesi. Это возможно, когда хост активирует HSTS для себя и всех своих поддоменов. Неполный HSTS — когда хост активирует HSTS только для себя.

Сессионные cookie с атрибутом `Domain` могут использоваться совместно с поддоменами. Следует избегать использования HTTP с поддоменами, чтобы предотвратить раскрытие незашифрованных cookie, отправляемых по HTTP. Чтобы проиллюстрировать эту проблему, предположим, что web-сайт `example.com` активирует HSTS без опции `includeSubDomains`. Сайт выдает сессионные cookie с атрибутом `Domain`, установленным на `example.com`. Возможна следующая атака:

1. Жертва отправляет запрос на `http://another-site.com`.
2. Злоумышленник модифицирует соответствующий ответ так, чтобы он инициировал запрос на `http://fake.example.com`.
3. Теперь браузер пытается получить доступ к `http://fake.example.com`, что разрешено настройками HSTS.
4. Поскольку запрос отправляется на поддомен `example.com` с установленным атрибутом `Domain`, он включает сессионные cookie, которые в открытом виде передаются через HTTP.

Чтобы предотвратить эту атаку необходимо активировать полноценный HSTS в домене верхнего уровня.

## Задачи тестирования

- Найти уязвимые сессионные cookie.
- Перехватить уязвимые cookie и оценить уровень риска.

## Как тестировать

Стратегия тестирования нацелена на сетевых злоумышленников, поэтому её необходимо применять только к сайтам, без полноценного HSTS (иначе сайты защищены, поскольку их cookie не передаются через HTTP). Мы предполагаем, что на тестируемом web-сайте есть две учётные записи для тестирования, одна из которых выступает в роли жертвы, а другая — злоумышленника. Мы моделируем сценарий, в котором злоумышленник крадет все cookie, не защищённые от раскрытия по HTTP, и предъявляет их web-сайту для доступа к учётной записи жертвы. Если этих cookie достаточно, чтобы действовать от имени жертвы, возможен перехват сессии.

Ниже шаги выполнения этого теста:

1. Войдите на web-сайт как жертва и перейдите на любую страницу с функцией, защищённой аутентификацией.
2. Удалите из хранилища все cookie, которые удовлетворяют любому из следующих условий.
    - если HSTS не поддерживается: есть атрибут `Secure`.
    - если HSTS поддерживается не полностью: есть атрибут `Secure` или нет атрибута `Domain`.
3. Сделайте копию хранилища cookie.
4. Вызовите защищённую функцию, указанную на шаге 1.
5. Проверьте, успешно ли выполнена операция на шаге 4. Если да, то атака удалась.
6. Очистите хранилище cookie, войдите как злоумышленник и перейдите на страницу на шаге 1.
7. Сохраните в хранилище cookie один за другим cookie, сохранённые на шаге 3.
8. Снова вызовите защищённую функцию, указанную на шаге 1.
9. Очистите хранилище cookie и снова войдите как как жертва.
10. Посмотрите, успешно ли выполнена операция на шаге 8 в учётной записи жертвы. Если да, то атака удалась; в противном случае сайт защищён от перехвата сессии.

Мы рекомендуем использовать разные машины или браузеры для жертвы и злоумышленника. Это позволяет уменьшить количество ложных срабатываний, если web-приложение выполняет «снятие отпечатков» (англ.: fingerprinting) для проверки доступа, разрешённого с помощью данного cookie. Более короткий, но менее точный сценарий тестирования требует только одной тестовой учётной записи. Он следует по тому же шаблону, но останавливается на шаге 5 (обратите внимание, что в этом случае шаг 3 бесполезен).

## Инструменты

- [OWASP ZAP](https://www.zaproxy.org)
- [JHijack - инструмент для перехвата сессии](https://github.com/yehgdotnet/JHijack)
