---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование атрибутов Cookie

|ID          |
|------------|
|WSTG-SESS-02|

## Обзор

Web-cookie (далее именуемые cookie или куки) часто являются ключевым вектором атаки злоумышленниками (обычно нацеленных на других пользователей), и приложение всегда должно проявлять должную осмотрительность для защиты файлов cookie.

HTTP — это протокол без сохранения состояния, что означает, что он не содержит ссылок на запросы, отправленные одним и тем же пользователем. Чтобы решить эту проблему, были созданы сессии и добавлены к HTTP-запросам. Браузеры, как подробно обсуждается в разделе [Тестирование хранилищ браузера](../11-Client-side_Testing/12-Testing_Browser_Storage.md), содержат несколько механизмов для хранения.

Наиболее часто используемым механизмом хранения сессий в браузерах является хранилище cookie. Cookie могут быть установлены сервером, путем включения заголовка [`Set-Cookie`](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/Set-Cookie) в HTTP-ответ или с помощью JavaScript. Cookie могут применяться по ряду причин, таких как:

- управление сессиями;
- персонализация;
- отслеживание.

Чтобы обезопасить данные в cookie, разработаны средства, помогающие изолировать cookie и ограничивать возможность их атаки. Со временем файлы cookie стали предпочтительным механизмом хранения для web-приложений, поскольку они обеспечивают большую гибкость в использовании и защите.

Средствами защиты cookie являются:

- [Атрибуты Cookie](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BA%D1%83%D0%BA%D0%B8)
- [Префиксы Cookie](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#%D0%BA%D1%83%D0%BA%D0%B8_%D1%81_%D0%BF%D1%80%D0%B5%D1%84%D0%B8%D0%BA%D1%81%D0%B0%D0%BC%D0%B8)

## Задача тестирования

- Убедитесь, что для cookie установлена безопасная конфигурация.

## Как тестировать

Ниже будет рассмотрено описание каждого атрибута и префикса. Тестировщик должен убедиться, что приложение использует их должным образом. Cookie можно просмотреть с помощью [перехватывающего прокси](#перехватывающие-прокси), или просмотрев хранилище cookie браузера.

### Атрибуты Cookie

#### Атрибут Secure

Атрибут [`Secure`](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#secure_(%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D1%8B%D0%B5)_%D0%B8_httponly_cookies) указывает браузеру отправлять cookie только в том случае, если запрос отправляется по защищённому каналу, например, `HTTPS`. Это поможет защитить cookie от передачи в незашифрованных запросах. Если к приложению можно получить доступ как по `HTTP`, так и по `HTTPS`, злоумышленник сможет перенаправить пользователя для отправки cookie в составе незащищённых запросов.

#### Атрибут HttpOnly

Атрибут [`HttpOnly`](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/Set-Cookie#httponly) используется для предотвращения атак, таких как раскрытие сессии, поскольку он не позволяет получить доступ к файлу cookie с помощью клиентского скрипта, например, JavaScript.

> Это не ограничивает всю поверхность XSS-атак, поскольку злоумышленник все равно может отправить запрос вместо пользователя, но значительно ограничивает область действия векторов XSS-атак.

#### Атрибут Domain

Атрибут [`Domain`](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#%D0%BE%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C_%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8_%D0%BA%D1%83%D0%BA%D0%B8) используется для сравнения домена cookie с доменом сервера, для которого выполняется HTTP-запрос. Если домены совпадают или если это поддомен, то следующим будет проверен атрибут [`path`](#атрибут-path).

Обратите внимание, что только хосты, принадлежащие указанному домену, могут установить cookie для этого домена. Кроме того, атрибут `domain` не может быть доменом верхнего уровня (например, `.org` или `.com`), чтобы серверы не могли устанавливать произвольные cookie для другого домена (например, для `owasp.org`). Если атрибут домена не задан, то в качестве значения по умолчанию для `domain` используется имя хоста сервера, сгенерировавшего cookie.

Например, если cookie установлен приложением `app.mydomain.com` без атрибута домена, то этот cookie будет отправляться во всех последующих запросах на `app.mydomain.com` и его поддомены (например, на `hacker.app.mydomain.com`), но не на `otherapp.mydomain.com`. Если разработчик хотел ослабить это ограничение, он мог установить атрибут `domain` в значение `mydomain.com`. В этом случае cookie будет отправляться во всех запросах на поддомены `app.mydomain.com` и `mydomain.com`, например, `hacker.app.mydomain.com`, и даже `bank.mydomain.com`. Если на поддомене был уязвимый сервер (например, `otherapp.mydomain.com`) и атрибут `domain` был установлен слишком вольно (например, `mydomain.com`), то уязвимый сервер мог быть использован для сбора cookie (например, сессионных токенов) по всему домену `mydomain.com`.

#### Атрибут Path

Атрибут [`Path`](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#%D0%BE%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C_%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8_%D0%BA%D1%83%D0%BA%D0%B8) играет важную роль в настройке области действия cookie в сочетании с [`domain`](#атрибут-domain). В дополнение к домену можно указать URL, для которого действителен cookie. Если домен и путь совпадают, то cookie будет отправлен в запросе. Как и в случае с атрибутом домена, если атрибут path задан слишком вольно, это может сделать приложение уязвимым для атак со стороны других приложений на том же сервере. Например, если атрибут path установлен на webroot `/`, то cookie будут отправляться каждому приложению в пределах одного домена (если несколько приложений находятся на одном сервере). Ниже примеры для случая нескольких приложений на одном сервере:

- `path=/bank`
- `path=/private`
- `path=/docs`
- `path=/docs/admin`

#### Атрибут Expires

Атрибут [`Expires`](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#%D0%BF%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%BD%D1%8B%D0%B5_cookies) используется для:

- установки постоянных cookie;
- ограничения их срока действия, если сессия длится слишком долго;
- принудительного удаления cookie, устанавливая для него прошедшую дату.

В отличие от [сессионных](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#%D1%81%D0%B5%D1%81%D1%81%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5_cookie), постоянные cookie будут использоваться браузером до истечения их срока действия. Как только срок действия превысит установленное время, браузер удалит cookie.

#### Атрибут SameSite

Атрибут [`SameSite`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite) используется для подтверждения того, что cookie не следует отправлять с межсайтовыми запросами. Эта функция позволяет серверу снизить риск утечки информации при наличии разных источников (cross-origin). В некоторых случаях он также используется в качестве стратегии снижения риска (или механизма эшелонированной защиты) для предотвращения атак [подделки межсайтовых запросов](05-Testing_for_Cross_Site_Request_Forgery.md). Этот атрибут можно использовать в трёх различных режимах:

- `Strict`
- `Lax`
- `None`

##### Значение Strict

Значение `Strict` — наиболее строгое использование атрибута `SameSite`, позволяющее браузеру отправлять cookie только в контексте от первого лица без навигации верхнего уровня. Другими словами, данные, связанные с cookie, будут отправляться только по запросам, соответствующим текущему сайту, отображаемому в строке URL браузера. Cookie не будет отправляться по запросам, сгенерированным сторонними web-сайтами. Это значение особенно рекомендуется для действий, выполняемых в том же домене. Однако у него могут быть ограничения, поскольку некоторые системы управления сессиями негативно влияют на навигацию пользователя. Поскольку браузер не будет отправлять cookie на запросы, сгенерированные из стороннего домена или электронной почты, пользователю потребуется снова входить в систему, даже если у него уже есть аутентифицированная сессия.

##### Значение Lax

Значение `Lax` является менее строгим, чем `Strict`. Cookie будет отправлен, если URL соответствует домену в cookie (от первого лица), даже если это ссылка со стороннего домена. Это значение считается большинством браузеров поведением по умолчанию, поскольку оно обеспечивает лучший пользовательский опыт, чем значение `Strict`. `Lax` не действует на ресурсы, для доступа к которым cookie не требуются например, для загрузки изображений или фреймов на сторонний сайт.

##### Значение None

Значение `None` указывает, что браузер будет отправлять cookie при межсайтовых запросах (стандартное поведение до появления `SameSite`)  только если также используется атрибут `Secure`, _например,_ `SameSite=None; Secure`. Это рекомендуемое значение, вместо того, чтобы вообще не указывать значение `SameSite`, поскольку оно вынуждает использовать атрибут [`secure`](#атрибут-secure).

### Префиксы Cookie

По своей сути cookie не могут гарантировать ни целостности, ни конфиденциальности хранящейся в них информации. Эти ограничения не позволяют серверу быть уверенным в том, в какие значения были установлены атрибуты данного cookie при его создании. Чтобы предоставить серверам такую возможность с сохранением обратной совместимости, была принята концепция  [`Префиксы имён cookie`](https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-cookie-prefixes-00), обеспечив передачу информации, включаемой в наименование файла cookie.

#### Префикс Host

Префикс [`__Host-`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Cookie_prefixes) требует, чтобы cookie соответствовали следующим условиям:

  1. cookie должен быть установлен с атрибутом [`Secure`](#атрибут-secure).
  2. cookie должен быть установлен из URI, который агент пользователя считает безопасным.
  3. отправляется только тому хосту, который установил cookie, и НЕ ДОЛЖЕН содержать атрибут [`Domain`](#атрибут-domain).
  4. cookie должен быть установлен с атрибутом [`Path`](#атрибут-path) в значении `/`, который отправляется с каждым запросом к хосту.

По этой причине cookie `Set-Cookie: __Host-SID=12345; Secure; Path=/` будет принят, а любой из приведённых ниже будет отклонён:
`Set-Cookie: __Host-SID=12345`
`Set-Cookie: __Host-SID=12345; Secure`
`Set-Cookie: __Host-SID=12345; Domain=site.example`
`Set-Cookie: __Host-SID=12345; Domain=site.example; Path=/`
`Set-Cookie: __Host-SID=12345; Secure; Domain=site.example; Path=/`

#### Префикс Secure

Префикс [`__Secure-`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Cookie_prefixes) является менее строгим, чем `__Host-` и может быть введён путём добавления чувствительной к регистру строки `__Secure-` к имени файла cookie. Ожидается, что любой cookie, соответствующий префиксу `__Secure-`будет удовлетворять следующим условиям:

  1. cookie должен быть установлен с атрибутом [`Secure`](#атрибут-secure).
  2. cookie должен быть установлен из URI, который агент пользователя считает безопасным.

### Рекомендованная практика

Атрибуты и префиксы должны применяться в зависимости от потребностей приложения и задач, решаемых с помощью cookie. Чем сильнее будет изолирован cookie, тем лучше.

Собрав всё вышесказанное воедино, мы можем определить наиболее безопасную конфигурацию атрибутов cookie следующим образом: `Set-Cookie: __Host-SID=<session token>; path=/; Secure; HttpOnly; SameSite=Strict`.

## Инструменты

### Перехватывающие прокси

- [OWASP Zed Attack Proxy Project](https://www.zaproxy.org)
- [Web Proxy Burp Suite](https://portswigger.net)

### Плагины для браузера

- [Tamper Data для FF Quantum](https://addons.mozilla.org/en-US/firefox/addon/tamper-data-for-ff-quantum/)
- [FireSheep для FireFox](https://github.com/codebutler/firesheep)
- [EditThisCookie для Chrome](https://chrome.google.com/webstore/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg?hl=en)
- [Cookiebro - Cookie Manager для FireFox](https://addons.mozilla.org/en-US/firefox/addon/cookiebro/)

## Ссылки

- [RFC 6265 - HTTP State Management Mechanism](https://www.rfc-editor.org/rfc/rfc6265)
- [RFC 7231 – Hypertext Transfer Protocol – HTTP 1.1](https://datatracker.ietf.org/doc/html/rfc7231)
- [Same-Site Cookies - draft-ietf-httpbis-cookie-same-site-00](https://datatracker.ietf.org/doc/draft-ietf-httpbis-cookie-same-site/)
- [The important "expires" attribute of Set-Cookie](https://seckb.yehg.net/2012/02/important-expires-attribute-of-set.html)
- [HttpOnly Session ID in URL and Page Body](https://seckb.yehg.net/2012/06/httponly-session-id-in-url-and-page.html)
