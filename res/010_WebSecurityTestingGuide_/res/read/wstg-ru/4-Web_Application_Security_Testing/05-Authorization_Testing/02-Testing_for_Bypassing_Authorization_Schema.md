---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование обхода схемы авторизации

|ID          |
|------------|
|WSTG-ATHZ-02|

## Обзор

Данный вид тестирования предназначен для анализа реализации схемы авторизации для каждой роли или привилегии для получения доступа к имеющимся функциям и ресурсам.

Для каждой конкретной роли, назначенной тестировщику во время оценки, и для каждой функции и запроса, которые приложение выполняет на этапе после аутентификации, необходимо проверить:

- Можно ли получить доступ к этому ресурсу, если пользователь не аутентифицирован?
- Можно ли получить доступ к этому ресурсу после выхода из системы?
- Можно ли получить доступ к функциям и ресурсам, которые должны быть доступны пользователю с другой ролью или привилегиями?

Попробуйте получить доступ к приложению в качестве администратора и отследить все административные функции.

- Можно ли получить доступ к административным функциям, если войти в систему как пользователь, не являющийся администратором?
- Можно ли использовать эти административные функции в качестве пользователя с другой ролью для которого это действие должно быть запрещено?

## Задача тестирования

- Оценить, возможен ли горизонтальный или вертикальный доступ.

## Как тестировать

- Получить доступ к ресурсам и выполнять операции по горизонтали.
- Получить доступ к ресурсам и выполнять операции по вертикали.

### Тестирование горизонтального обхода схемы авторизации

Для каждой функции, конкретной роли или запроса, выполняемого приложением, необходимо проверить:

- Можно ли получить доступ к ресурсам, которые должны быть доступны пользователю под другой учётной записью с той же ролью или привилегиями?
- Можно ли обращаться к функциям на ресурсах, которые должны быть доступны пользователю под другой учётной записью?

Для каждой роли:

1. Зарегистрируйте или создайте двух пользователей с одинаковыми привилегиями.
2. Создайте и поддерживайте активными две разных сессии (по одной для каждого пользователя).
3. Для каждого запроса измените соответствующие параметры и идентификатор сессии с токена один на токен два и диагностируйте ответы для каждого токена.
4. Приложение будет считаться уязвимым, если ответы совпадут, содержат одни и те же данные пользователя или указывают на успешную работу с ресурсом или данными других пользователей.

Например, предположим, что функция `viewSettings` входит в меню каждой учётной записи приложения с той же ролью, и к ней можно получить доступ, запросив URL `https://www.example.com/account/viewSettings`. Затем при вызове функции `viewSettings` создаётся следующий HTTP-запрос:

```http
POST /account/viewSettings HTTP/1.1
Host: www.example.com
[другие HTTP-заголовки]
Cookie: SessionID=USER_SESSION

username=example_user
```

Правильный и закономерный ответ:

```http
HTTP1.1 200 OK
[другие HTTP-заголовки]

{
  "username": "example_user",
  "email": "example@email.com",
  "address": "Example Address"
}
```

С тем же параметром `username` может попытаться выполнить этот запрос и злоумышленник:

```http
POST /account/viewSettings HTTP/1.1
Host: www.example.com
[другие HTTP-заголовки]
Cookie: SessionID=ATTACKER_SESSION

username=example_user
```

Если ответ злоумышленника содержит данные `example_user`, то приложение уязвимо для атак с боковым (т.е. горизонтальным) перемещением, когда пользователь может читать или изменять данные другого пользователя.

### Тестирование доступа к административным функциям

Например, предположим, что функция `addUser` входит в меню администратора приложения, и к ней можно получить доступ, запросив URL `https://www.example.com/admin/addUser`.

Затем при вызове функции `addUser` создаётся следующий HTTP-запрос:

```http
POST /admin/addUser HTTP/1.1
Host: www.example.com
[...]

userID=fakeuser&role=3&group=grp001
```

Дальнейшие вопросы или идеи будут идти в следующих направлениях:

- Что произойдёт, если пользователь, не являющийся администратором, попытается выполнить этот запрос?
- Будет ли создан пользователь?
- Если да, то сможет ли новый пользователь воспользоваться своими привилегиями?

### Проверка доступа к ресурсам, предназначенным для другой роли

Различные приложения устанавливают элементы управления ресурсами на основе ролей пользователей. Давайте возьмём в качестве примера резюме или CV (curriculum vitae), загружаемые из формы карьеры в корзину S3.

Попробуйте получить доступ к расположению этих файлов в качестве обычного пользователя. Если вы можете извлечь, изменить или удалить их, значит, приложение уязвимо.

### Тестирование обработки запросов со специальными заголовками

Некоторые приложения поддерживают нестандартные заголовки, такие как `X-Original-URL` или `X-Rewrite-URL`, чтобы разрешить переопределение целевого URL в запросах на тот, который указан в значении заголовка.

Такое поведение можно использовать в ситуации, когда приложение находится за компонентом, который применяет ограничение доступа на основе URL-адреса запроса.

Видом ограничения доступа, основанном на URL запроса, может, например, быть блокировка из Интернета доступа к консоли администрирования, которая открывается через `/console` или `/admin`.

Чтобы узнать поддерживаются ли заголовки `X-Original-URL` или `X-Rewrite-URL`, можно предпринять следующие шаги:

#### 1. Отправить обычный запрос без заголовка X-Original-Url или X-Rewrite-Url

```http
GET / HTTP/1.1
Host: www.example.com
[...]
```

#### 2. Отправить запрос с заголовком X-Original-Url, указывающим на несуществующий ресурс

```http
GET / HTTP/1.1
Host: www.example.com
X-Original-URL: /donotexist1
[...]
```

#### 3. Отправить запрос с заголовком X-Rewrite-Url, указывающим на несуществующий ресурс

```http
GET / HTTP/1.1
Host: www.example.com
X-Rewrite-URL: /donotexist2
[...]
```

Если ответ на любой из этих запросов содержит маркеры того, что ресурс не был найден, это указывает на то, что приложение поддерживает специальные заголовки запросов. Эти маркеры могут включать в себя HTTP-код статуса ответа 404 или сообщение "ресурс не найден" в теле ответа.

Как только подтвердится поддержка заголовка `X-Original-URL` или `X-Rewrite-URL` можно использовать предполагаемый способ обхода ограничения доступа, отправляя ожидаемый запрос в приложение, но указав URL как разрешённый фронтальным компонентом в качестве основного URL запроса, а реальный целевой URL — в заголовке `X-Original-URL` или `X-Rewrite-URL` (в зависимости от того, какой из них поддерживается). Если поддерживаются оба, попробуйте один за другим, чтобы проверить, для какого заголовка работает обход.

#### 4. Другие заголовки, которые следует рассмотреть

Часто панели администратора или связанные с администрированием функциональные возможности доступны только клиентам в локальных сетях, поэтому для получения доступа можно злоупотреблять различными прокси-серверами или HTTP-заголовками, связанными с пересылкой. Вот некоторые заголовки и значения для тестирования:

- Заголовки:
    - `X-Forwarded-For`
    - `X-Forward-For`
    - `X-Remote-IP`
    - `X-Originating-IP`
    - `X-Remote-Addr`
    - `X-Client-IP`
- Значения
    - `127.0.0.1` (или другие в пространстве `127.0.0.0/8` или `::1/128`)
    - `localhost`
    - Любые частные IP-адреса из [RFC1918](https://tools.ietf.org/html/rfc1918):
        - `10.0.0.0/8`
        - `172.16.0.0/12`
        - `192.168.0.0/16`
    - Link-local адреса: `169.254.0.0/16` из [RFC3927](https://www.rfc-editor.org/rfc/rfc3927) или `FE80::/10` из [RFC4862](https://www.rfc-editor.org/rfc/rfc4862#section-5.3).

Примечание: указание порта рядом с адресом или именем хоста также может помочь обойти периметровые средства защиты, такие как WAF и т.п.
Например: `127.0.0.4:80`, `127.0.0.4:443`, `127.0.0.4:43982`

## Меры защиты

Чтобы гарантировать отсутствие несанкционированного доступа применяйте принцип наименьших привилегий по отношению к пользователям, ролям и ресурсам.

## Инструменты

- [OWASP Zed Attack Proxy (ZAP)](https://www.zaproxy.org/)
    - [дополнение Access Control Testing](https://www.zaproxy.org/docs/desktop/addons/access-control-testing/)
- [Port Swigger Burp Suite](https://portswigger.net/burp)
    - [расширение AuthMatrix](https://github.com/SecurityInnovation/AuthMatrix/)
    - [расширение Autorize](https://github.com/Quitten/Autorize)

## Ссылки

[OWASP Application Security Verification Standard 4.0.3](https://github.com/OWASP/ASVS/blob/master/4.0/ru/0x12-V4-Access-Control.md).
