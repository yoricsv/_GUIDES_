---

layout: col-document
title: WSTG - Latest
tags: WSTG

---

{% include breadcrumb.html %}
# Тестирование функций изменения или сброса пароля

|ID          |
|------------|
|WSTG-ATHN-09|

## Обзор

Для любого приложения, которое требует от пользователя аутентификации с помощью пароля, должен быть механизм, с помощью которого пользователь может восстановить доступ к своей учётной записи, если он забудет свой пароль. Хотя иногда это может быть неавтоматизированной процедурой, которая включает в себя обращение к владельцу web-сайта или в службу сопровождения, пользователям часто разрешается выполнять самостоятельный сброс пароля и восстанавливать доступ к своей учётной записи, подтверждая каким-либо другим образом свою личность.

Поскольку эта функция обеспечивает прямой путь к компрометации учётной записи пользователя, крайне важно, чтобы она была реализована безопасно.

## Задача тестирования

- Определить, позволяют ли функции смены и сброса пароля компрометировать учётные записи.

## Как тестировать

### Сбор информации

Первым шагом является сбор информации об имеющихся механизмах, позволяющих пользователю сбросить свой пароль в приложении. Если на сайте есть несколько интерфейсов (например, web-, мобильное приложения и API), и они предоставляют разные функции, то все они должны быть проверены.

Как только это будет установлено, определите, какая информация требуется для того, чтобы пользователь инициировал сброс пароля. Это может быть имя пользователя или адрес электронной почты (и то и другое можно узнать из общедоступной информации), но это также может быть внутренний идентификатор пользователя.

### Общие вопросы

Независимо от конкретных методов, используемых для сброса паролей, необходимо учитывать ряд общих вопросов:

- Является ли процесс сброса пароля менее строгим, чем процесс аутентификации?

  Процесс сброса пароля предоставляет альтернативный механизм доступа к учётной записи пользователя и поэтому должен быть по крайней мере таким же безопасным, как и обычный процесс аутентификации. Однако он может обеспечить более простой способ скомпрометировать учётную запись, особенно если она использует менее стойкие факторы аутентификации, такие как контрольные вопросы.

  Кроме того, процесс сброса пароля может обойти требование использования многофакторной аутентификации (MFA), что может существенно снизить защиту приложения.

- Есть ли ограничение по частоте запросов или другая защита от автоматических атак?

  Как и в случае с любым механизмом аутентификации, процесс сброса пароля должен иметь защиту от автоматических атак или атак методом перебора. Существует множество различных методов, которые можно использовать для достижения этой цели, таких как ограничение скорости или использование CAPTCHA. Это особенно важно для функций, которые запускают внешние действия (например, отправку электронной почты или SMS), или когда пользователь вводит токен сброса пароля.

  Также можно защититься от атак методом перебора, заблокировав учётную запись в процессе сброса пароля после определённого количества последовательных попыток. Однако это также может помешать законному пользователю сбросить свой пароль и восстановить доступ к своей учётной записи.

- Уязвим ли процесс к распространённым атакам?

  Помимо конкретных областей, обсуждаемых в этом руководстве, также важно проверить наличие других распространённых уязвимостей, таких как SQL-инъекции или межсайтовые скрипты.

- Разрешает ли процесс сброса перебор пользователей?

  См. раздел [Перебор и угадывание учётных записей пользователей](../03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account.md) для получения дополнительной информации.

### Email: отправка нового пароля

В этой модели новый пароль высылается пользователю по электронной почте после подтверждения его личности. Это считается менее безопасным по двум основным причинам:

- Пароль отправляется пользователю в незашифрованном виде.
- Пароль для учётной записи меняется при отправке запроса, что фактически блокирует доступ пользователя к своей учётной записи до тех пор, пока он не получит электронное письмо. Повторяя запросы, можно запретить пользователю доступ к своей учётной записи.

Там, где используется этот подход, следует рассмотреть следующие вопросы:

- Принуждается ли пользователь менять пароль при первом входе в систему?

  Новый пароль отправляется по электронной почте в незашифрованном виде и может оставаться в папке Входящие неопределённое время, пока пользователь не удалит электронное письмо. Таким образом, он должен поменять пароль, как только войдёт в систему в первый раз.

- Безопасно ли сгенерирован пароль?

  Пароль должен быть сгенерирован с использованием криптографически стойкого генератора псевдослучайных чисел ([CSPRNG](https://ru.wikipedia.org/wiki/%D0%9A%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8_%D1%81%D1%82%D0%BE%D0%B9%D0%BA%D0%B8%D0%B9_%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D1%82%D0%BE%D1%80_%D0%BF%D1%81%D0%B5%D0%B2%D0%B4%D0%BE%D1%81%D0%BB%D1%83%D1%87%D0%B0%D0%B9%D0%BD%D1%8B%D1%85_%D1%87%D0%B8%D1%81%D0%B5%D0%BB)) и должен быть достаточно длинным, чтобы предотвратить угадывание пароля или атаки методом перебора. Для безопасного и удобного использования он должен быть сформирован с использованием подхода в стиле безопасной парольной фразы (т.е. словосочетания из нескольких слов), а не одной строки из случайных символов.

- Отправляется ли пользователю текущий пароль?

  Вместо создания нового пароля для пользователя некоторые приложения отправляют его существующий пароль. Это очень небезопасный подход, поскольку он передаёт текущий пароль по незашифрованной электронной почте. Кроме того, если сайт может восстановить существующий пароль, это означает, что пароли либо хранятся с использованием обратимого шифрования, либо (что более вероятно) в виде незашифрованного открытого текста, что представляет собой серьёзную уязвимость в системе безопасности.

- Электронные письма отправляются с домена с защитой от спуфинга?

  В домене должны быть настроены [SPF, DKIM и DMARC](https://help.mail.ru/postmaster/technical-settings/notes), чтобы злоумышленники не могли подделывать электронные письма с него, что может быть использовано в социальной инженерии.

- Достаточно ли защищена электронная почта?

  Электронные письма обычно отправляются в незашифрованном виде, и во многих случаях учётная запись электронной почты пользователя не защищена MFA. Email также может быть общим для группы людей, особенно в корпоративной среде.

  Подумайте, подходит ли функция сброса пароля через электронную почту для контекста тестируемого приложения.

### Email: отправка ссылки

В этой модели пользователям по электронной почте направляется ссылка, содержащая токен. Затем они могут перейти по этой ссылке, и им будет предложено ввести новый пароль на сайте. Это наиболее распространённый подход для сброса пароля, но его сложнее реализовать, чем рассмотренный ранее. Ключевые вопросы для рассмотрения:

- Используется ли в ссылке HTTPS?

  Если токен отправляется по незашифрованному протоколу HTTP, злоумышленник может его перехватить.

- Можно ли использовать ссылку несколько раз?

  Срок действия ссылок должен истекать сразу после их использования, в противном случае они создают постоянный бэкдор для учётной записи.

- Истекает ли срок действия ссылки, если она остаётся неиспользованной?

  Срок действия ссылки должны быть ограничен. Конкретный срок будет зависеть от сайта, но он редко должен превышать один час.

- Достаточно ли токен длинный и случайный?

  Безопасность процесса полностью зависит от того, сможет ли злоумышленник угадать или подобрать токен. Токены должны формироваться с помощью криптографически стойкого генератора псевдослучайных чисел (CSPRNG) и должны быть достаточно длинными, чтобы злоумышленник не смог их угадать или перебрать. 128 бит (или 32 шестнадцатеричных символа) — пока достаточный минимум, чтобы сделать такую онлайн-атаку нецелесообразной.

  Токены никогда не должны генерироваться на основе известных значений, например, путем использования MD5-хэша электронной почты пользователя с помощью `md5($email)` или с GUID, которые могут использовать некриптостойкие генераторы псевдослучайных чисел (PRNG) или даже могут не быть случайными в зависимости от типа GUID.

  Альтернативный подход к случайным токенам заключается в использовании токена, подписанного электронной подписью, например, JWT. В этом случае следует провести стандартные тесты JWT (проверяется ли подпись, можно ли использовать алгоритм "nONe", можно ли подобрать ключ HMAC и т.д.). Дополнительную информацию см. в разделе [Тестирование JWT](../06-Session_Management_Testing/10-Testing_JSON_Web_Tokens.md).

- Содержит ли ссылка идентификатор пользователя?

  Иногда ссылка для сброса пароля может включать идентификатор пользователя, а также токен, например `reset.php?userid=1&token=123456`. В этом случае можно изменяя параметр `userid`, сбрасывать пароли других пользователей.

- Можно ли ввести другой заголовок хоста?

  Если приложение доверяет значению заголовка `Host` и использует его при генерации ссылки для сброса пароля, то может оказаться возможным украсть токены, вводя в запрос модифицированный заголовок `Host`. Дополнительную информацию см. в разделе [Тестирование инъекции заголовка хоста](../07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection.md).

- Доступна ли ссылка другим лицам?

  Если страница, на которую переходит пользователь, содержит контент от других сторон (например, загрузку скриптов из других доменов), то токен сброса в URL-адресе может отображаться в HTTP-заголовке `Referer`, отправляемом в этих запросах. Для защиты от этого можно использовать HTTP-заголовок Referrer-Policy, поэтому проверьте, задан ли он для страницы.

  Кроме того, если страница содержит скрипты отслеживания, web-аналитики или рекламы, токен также будет доступен для них.

- Защищён ли от спуфинга домен, с которого отправляются электронные письма?

  В домене должны быть настроены SPF, DKIM и DMARC, чтобы злоумышленники не могли подделывать электронные письма с него, что может быть использовано в социальной инженерии.

- Достаточно ли защищена электронная почта?

  Электронные письма обычно отправляются в незашифрованном виде, и во многих случаях учётная запись электронной почты пользователя не защищена MFA. Email также может быть общим для группы людей, особенно в корпоративной среде.

  Подумайте, подходит ли функция сброса пароля через электронную почту для контекста тестируемого приложения.

### Токены, отправляемые с помощью SMS или звонка по телефону

Вместо отправки токена по электронной почте альтернативным подходом является отправка его с помощью SMS или автоматического телефонного звонка, который затем пользователь вводит в приложении. Ключевые вопросы для рассмотрения:

- Достаточно ли токен длинный и случайный?

  Токены, отправляемые таким образом, обычно короче, поскольку они предназначены для ввода вручную, а не для встраивания в ссылку. Довольно часто приложения используют число из шести цифр, которое даёт всего ~20 бит энтропии (можно подобрать онлайн), вместо более длинного токена, применяемого для электронной почты.

  Для этого варианта важно защищать функцию сброса пароля от атак методом перебора.

- Можно ли использовать токен несколько раз?

  Токены должны становиться недействительными сразу после их использования, иначе они обеспечивают постоянный бэкдор для учётной записи.

- Истекает ли срок действия токена, если он остаётся неиспользованным?

  Поскольку более короткие токены сильнее подвержены атакам методом перебора, для них следует использовать более короткий срок действия, чтобы закрывать окно, доступное злоумышленнику для проведения атаки.

- Есть ли ограничения по частоте запросов?

  Отправка SMS-сообщения или автоматический телефонный звонок требуют от пользователя значительно больше внимания, чем отправка электронной почты, и могут применяться для причинения беспокойства или даже атак типа «отказ в обслуживании» на его телефон. Приложение должно реализовать ограничение частоты запросов, чтобы это предотвращать.

  Кроме того, SMS-сообщения и телефонные звонки часто сопряжены с финансовыми расходами для отправляющей стороны. Если злоумышленник способен вызвать отправку большого количества сообщений, это может привести к значительным затратам для оператора web-сайта. Это особенно заметно, если они отправляются на международные номера или на номера с премиальными тарифами. Однако разрешение звонков на международные номера может быть требованием приложения.

- Достаточно ли защищены SMS или телефонный звонки?

  Продемонстрировано [множество атак](https://www.ncsc.gov.uk/guidance/protecting-sms-messages-used-in-critical-business-processes#section_4), позволяющих злоумышленнику перехватить SMS-сообщения. Существуют противоречивые мнения о том, достаточно ли безопасны SMS, чтобы их можно было использовать в качестве фактора аутентификации.

  Обычно, имея физический доступ к устройству, можно ответить на автоматический телефонный звонок, не требуя ввода PIN-кода или отпечатка пальца для разблокировки телефона. В некоторых обстоятельствах (например, в открытом пространстве офиса) это может позволить внутреннему злоумышленнику тривиально сбросить пароль другого пользователя, подойдя к его столу, пока его нет рядом.

  Подумайте, подходят ли SMS или автоматические телефонные звонки, к контексту тестируемого приложения.

### Контрольные вопросы

Вместо того, чтобы отправлять ссылку или новый пароль, в качестве механизма аутентификации пользователя можно использовать контрольные (они же "секретные") вопросы. Это считается плохой практикой, и её не следует использовать, если есть варианты получше.

Дополнительную информацию см. в разделе [Тестирование ответа на контрольный вопрос](08-Testing_for_Weak_Security_Question_Answer.md).

### Аутентифицированное изменение пароля

Как только пользователь подтвердит свою личность (с помощью ссылки для сброса пароля, кода восстановления или путем входа в приложение), он сможет изменить свой пароль. Ключевыми вопросами для рассмотрения являются:

- Указывается ли идентификатор пользователя при установке пароля?

  Если идентификатор пользователя включается в запрос на сброс пароля, но не проверяется, возможно, его можно модифицировать и изменить пароли других пользователей.

- Требуется ли пользователю повторная аутентификация?

  Если вошедший в систему пользователь пытается изменить свой пароль, его следует попросить повторно пройти аутентификацию с текущим паролем, чтобы защититься от злоумышленника, который получил доступ к сессии, временно оставшейся без присмотра. Если у пользователя включена многофакторная аутентификация, он, как правило, будет повторно аутентифицироваться с её помощью, а не через пароль.

- Уязвима ли форма смены пароля для CSRF?

  Если от пользователя не требуется повторная аутентификация, то можно провести CSRF-атаку на форму сброса пароля, что позволит скомпрометировать его учётную запись. Дополнительную информацию см. в разделе [Тестирование на подделку межсайтовых запросов](../06-Session_Management_Testing/05-Testing_for_Cross_Site_Request_Forgery.md).

- Насколько безопасна и эффективна парольная политика?

  Парольная политика должна быть единообразной для всех функций регистрации, изменения и сброса пароля. Дополнительную информацию см. в разделе [Тестирование парольной политики](07-Testing_for_Weak_Password_Policy.md).

## Ссылки

- [Памятка OWASP по забытым паролям](https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html)
